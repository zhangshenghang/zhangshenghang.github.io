<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>数据湖Iceberg-SparkSQL集成(4) | Jast blog</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="后端技术博客,专注大数据、java后端、运维学习与总结。Hadoop、Hbase、Spark、Flink等技术文章。">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.6b2f3ec1.css" as="style"><link rel="preload" href="/assets/js/app.a5c64990.js" as="script"><link rel="preload" href="/assets/js/2.9cc65402.js" as="script"><link rel="preload" href="/assets/js/249.4c6c1707.js" as="script"><link rel="prefetch" href="/assets/js/10.ba6c1d32.js"><link rel="prefetch" href="/assets/js/100.ccd1a39e.js"><link rel="prefetch" href="/assets/js/101.91cade52.js"><link rel="prefetch" href="/assets/js/102.027c71bd.js"><link rel="prefetch" href="/assets/js/103.de30883d.js"><link rel="prefetch" href="/assets/js/104.da277c7f.js"><link rel="prefetch" href="/assets/js/105.3bf9d637.js"><link rel="prefetch" href="/assets/js/106.a9e6dde2.js"><link rel="prefetch" href="/assets/js/107.860f85f9.js"><link rel="prefetch" href="/assets/js/108.4db25d5c.js"><link rel="prefetch" href="/assets/js/109.25820bdd.js"><link rel="prefetch" href="/assets/js/11.f1952de8.js"><link rel="prefetch" href="/assets/js/110.b15ac071.js"><link rel="prefetch" href="/assets/js/111.2de3d63d.js"><link rel="prefetch" href="/assets/js/112.0d5386a4.js"><link rel="prefetch" href="/assets/js/113.0039984c.js"><link rel="prefetch" href="/assets/js/114.dbfd963d.js"><link rel="prefetch" href="/assets/js/115.1dcd21d8.js"><link rel="prefetch" href="/assets/js/116.48600243.js"><link rel="prefetch" href="/assets/js/117.bbcc1071.js"><link rel="prefetch" href="/assets/js/118.d7cd7dc2.js"><link rel="prefetch" href="/assets/js/119.7b7e1b39.js"><link rel="prefetch" href="/assets/js/12.83759251.js"><link rel="prefetch" href="/assets/js/120.330446cb.js"><link rel="prefetch" href="/assets/js/121.fd2c8119.js"><link rel="prefetch" href="/assets/js/122.ec0a20e0.js"><link rel="prefetch" href="/assets/js/123.256a201a.js"><link rel="prefetch" href="/assets/js/124.e46e6a5a.js"><link rel="prefetch" href="/assets/js/125.93869b30.js"><link rel="prefetch" href="/assets/js/126.6e6b45bb.js"><link rel="prefetch" href="/assets/js/127.7b7d0615.js"><link rel="prefetch" href="/assets/js/128.75398be2.js"><link rel="prefetch" href="/assets/js/129.1410d7a1.js"><link rel="prefetch" href="/assets/js/13.bd1c4176.js"><link rel="prefetch" href="/assets/js/130.bfe1cad6.js"><link rel="prefetch" href="/assets/js/131.286e4fb2.js"><link rel="prefetch" href="/assets/js/132.298f0154.js"><link rel="prefetch" href="/assets/js/133.25e9e0fd.js"><link rel="prefetch" href="/assets/js/134.a156117e.js"><link rel="prefetch" href="/assets/js/135.b5580f83.js"><link rel="prefetch" href="/assets/js/136.8446e66a.js"><link rel="prefetch" href="/assets/js/137.4291a0c3.js"><link rel="prefetch" href="/assets/js/138.03e36af0.js"><link rel="prefetch" href="/assets/js/139.753d5e11.js"><link rel="prefetch" href="/assets/js/14.c30cabe4.js"><link rel="prefetch" href="/assets/js/140.b136f09c.js"><link rel="prefetch" href="/assets/js/141.6e321584.js"><link rel="prefetch" href="/assets/js/142.19594f5a.js"><link rel="prefetch" href="/assets/js/143.83b5a670.js"><link rel="prefetch" href="/assets/js/144.143de838.js"><link rel="prefetch" href="/assets/js/145.ead82905.js"><link rel="prefetch" href="/assets/js/146.f037d4ec.js"><link rel="prefetch" href="/assets/js/147.2416d84a.js"><link rel="prefetch" href="/assets/js/148.c672f1e5.js"><link rel="prefetch" href="/assets/js/149.caf20103.js"><link rel="prefetch" href="/assets/js/15.a36cf9fa.js"><link rel="prefetch" href="/assets/js/150.43e61e26.js"><link rel="prefetch" href="/assets/js/151.d3d8d0ca.js"><link rel="prefetch" href="/assets/js/152.4ebef6e9.js"><link rel="prefetch" href="/assets/js/153.3c49a9bd.js"><link rel="prefetch" href="/assets/js/154.6d6660a6.js"><link rel="prefetch" href="/assets/js/155.e80efaba.js"><link rel="prefetch" href="/assets/js/156.1a2c1468.js"><link rel="prefetch" href="/assets/js/157.65dab597.js"><link rel="prefetch" href="/assets/js/158.5342d014.js"><link rel="prefetch" href="/assets/js/159.a1c44f33.js"><link rel="prefetch" href="/assets/js/16.01d2a439.js"><link rel="prefetch" href="/assets/js/160.f6de5687.js"><link rel="prefetch" href="/assets/js/161.4a33f4f3.js"><link rel="prefetch" href="/assets/js/162.293b5c45.js"><link rel="prefetch" href="/assets/js/163.94f8c46f.js"><link rel="prefetch" href="/assets/js/164.e9874af4.js"><link rel="prefetch" href="/assets/js/165.c40136e3.js"><link rel="prefetch" href="/assets/js/166.b9514f6f.js"><link rel="prefetch" href="/assets/js/167.b55df3a5.js"><link rel="prefetch" href="/assets/js/168.bfd7b561.js"><link rel="prefetch" href="/assets/js/169.ec8ee5ab.js"><link rel="prefetch" href="/assets/js/17.4a34d519.js"><link rel="prefetch" href="/assets/js/170.4e8ebcdb.js"><link rel="prefetch" href="/assets/js/171.046b515a.js"><link rel="prefetch" href="/assets/js/172.0bfdc048.js"><link rel="prefetch" href="/assets/js/173.b1065684.js"><link rel="prefetch" href="/assets/js/174.a26151c8.js"><link rel="prefetch" href="/assets/js/175.af67d813.js"><link rel="prefetch" href="/assets/js/176.8351882c.js"><link rel="prefetch" href="/assets/js/177.a5985895.js"><link rel="prefetch" href="/assets/js/178.3803a24d.js"><link rel="prefetch" href="/assets/js/179.943ff67a.js"><link rel="prefetch" href="/assets/js/18.40ac91d6.js"><link rel="prefetch" href="/assets/js/180.88c378a7.js"><link rel="prefetch" href="/assets/js/181.55d56274.js"><link rel="prefetch" href="/assets/js/182.2a01d579.js"><link rel="prefetch" href="/assets/js/183.4f593acd.js"><link rel="prefetch" href="/assets/js/184.a476b544.js"><link rel="prefetch" href="/assets/js/185.02a334a8.js"><link rel="prefetch" href="/assets/js/186.e13edcb1.js"><link rel="prefetch" href="/assets/js/187.522769b5.js"><link rel="prefetch" href="/assets/js/188.c7145e3e.js"><link rel="prefetch" href="/assets/js/189.19159109.js"><link rel="prefetch" href="/assets/js/19.c6a1d5d4.js"><link rel="prefetch" href="/assets/js/190.7eeef6ca.js"><link rel="prefetch" href="/assets/js/191.d891e4cd.js"><link rel="prefetch" href="/assets/js/192.d57db752.js"><link rel="prefetch" href="/assets/js/193.51d140b9.js"><link rel="prefetch" href="/assets/js/194.719c07fb.js"><link rel="prefetch" href="/assets/js/195.d1f4ad39.js"><link rel="prefetch" href="/assets/js/196.89045dfe.js"><link rel="prefetch" href="/assets/js/197.8b582e17.js"><link rel="prefetch" href="/assets/js/198.dd108c0b.js"><link rel="prefetch" href="/assets/js/199.6dcb685e.js"><link rel="prefetch" href="/assets/js/20.2c61c41b.js"><link rel="prefetch" href="/assets/js/200.980a6e3a.js"><link rel="prefetch" href="/assets/js/201.0022dd0a.js"><link rel="prefetch" href="/assets/js/202.b1771899.js"><link rel="prefetch" href="/assets/js/203.5b8c52fb.js"><link rel="prefetch" href="/assets/js/204.1de31510.js"><link rel="prefetch" href="/assets/js/205.e4c193e9.js"><link rel="prefetch" href="/assets/js/206.c43d57fd.js"><link rel="prefetch" href="/assets/js/207.a7696d68.js"><link rel="prefetch" href="/assets/js/208.5b51bd38.js"><link rel="prefetch" href="/assets/js/209.f2c6e228.js"><link rel="prefetch" href="/assets/js/21.9630f7d2.js"><link rel="prefetch" href="/assets/js/210.d499c1e8.js"><link rel="prefetch" href="/assets/js/211.7caf7044.js"><link rel="prefetch" href="/assets/js/212.eb88150d.js"><link rel="prefetch" href="/assets/js/213.7a66a771.js"><link rel="prefetch" href="/assets/js/214.650eca57.js"><link rel="prefetch" href="/assets/js/215.d58c9428.js"><link rel="prefetch" href="/assets/js/216.17c5fbbb.js"><link rel="prefetch" href="/assets/js/217.cc6016b1.js"><link rel="prefetch" href="/assets/js/218.0f2ad43c.js"><link rel="prefetch" href="/assets/js/219.0cc56748.js"><link rel="prefetch" href="/assets/js/22.ae388eb6.js"><link rel="prefetch" href="/assets/js/220.c6da1ce9.js"><link rel="prefetch" href="/assets/js/221.c2499e5c.js"><link rel="prefetch" href="/assets/js/222.b87b5047.js"><link rel="prefetch" href="/assets/js/223.14221086.js"><link rel="prefetch" href="/assets/js/224.48415224.js"><link rel="prefetch" href="/assets/js/225.3323e2fd.js"><link rel="prefetch" href="/assets/js/226.97115136.js"><link rel="prefetch" href="/assets/js/227.51ac123d.js"><link rel="prefetch" href="/assets/js/228.ac7adb8a.js"><link rel="prefetch" href="/assets/js/229.4423a81d.js"><link rel="prefetch" href="/assets/js/23.1b7a265e.js"><link rel="prefetch" href="/assets/js/230.93f5e7f6.js"><link rel="prefetch" href="/assets/js/231.5c829d72.js"><link rel="prefetch" href="/assets/js/232.b497791c.js"><link rel="prefetch" href="/assets/js/233.0759dd52.js"><link rel="prefetch" href="/assets/js/234.5c77c942.js"><link rel="prefetch" href="/assets/js/235.62c61b2a.js"><link rel="prefetch" href="/assets/js/236.d6e69fa9.js"><link rel="prefetch" href="/assets/js/237.0392f6c6.js"><link rel="prefetch" href="/assets/js/238.46dc8425.js"><link rel="prefetch" href="/assets/js/239.6f9df60c.js"><link rel="prefetch" href="/assets/js/24.32543ee9.js"><link rel="prefetch" href="/assets/js/240.bae013f7.js"><link rel="prefetch" href="/assets/js/241.c81b66a5.js"><link rel="prefetch" href="/assets/js/242.9296a5c8.js"><link rel="prefetch" href="/assets/js/243.4b16b49b.js"><link rel="prefetch" href="/assets/js/244.f9ee3d4b.js"><link rel="prefetch" href="/assets/js/245.a1a4b62f.js"><link rel="prefetch" href="/assets/js/246.3c7d7878.js"><link rel="prefetch" href="/assets/js/247.03056af4.js"><link rel="prefetch" href="/assets/js/248.cd672886.js"><link rel="prefetch" href="/assets/js/25.bd2e359f.js"><link rel="prefetch" href="/assets/js/250.26ffc44a.js"><link rel="prefetch" href="/assets/js/251.85db4e67.js"><link rel="prefetch" href="/assets/js/252.d4febe54.js"><link rel="prefetch" href="/assets/js/253.df2ea5e2.js"><link rel="prefetch" href="/assets/js/254.b8d0d20e.js"><link rel="prefetch" href="/assets/js/255.49c4ec7d.js"><link rel="prefetch" href="/assets/js/256.98014536.js"><link rel="prefetch" href="/assets/js/257.25c9f009.js"><link rel="prefetch" href="/assets/js/258.1ae5e480.js"><link rel="prefetch" href="/assets/js/259.7333eaaf.js"><link rel="prefetch" href="/assets/js/26.dc9e3004.js"><link rel="prefetch" href="/assets/js/260.8edc3b07.js"><link rel="prefetch" href="/assets/js/261.e6ee2a4e.js"><link rel="prefetch" href="/assets/js/262.f248c8c3.js"><link rel="prefetch" href="/assets/js/263.82be0c8f.js"><link rel="prefetch" href="/assets/js/264.55691777.js"><link rel="prefetch" href="/assets/js/265.e346b753.js"><link rel="prefetch" href="/assets/js/266.92dc4b9b.js"><link rel="prefetch" href="/assets/js/267.c32ec0a7.js"><link rel="prefetch" href="/assets/js/268.0b55a11d.js"><link rel="prefetch" href="/assets/js/269.cc1d3112.js"><link rel="prefetch" href="/assets/js/27.f6948f93.js"><link rel="prefetch" href="/assets/js/270.8151a5d3.js"><link rel="prefetch" href="/assets/js/271.7a93b23b.js"><link rel="prefetch" href="/assets/js/272.473c500f.js"><link rel="prefetch" href="/assets/js/273.b9a56533.js"><link rel="prefetch" href="/assets/js/274.e7b60a0c.js"><link rel="prefetch" href="/assets/js/275.2adf8ff0.js"><link rel="prefetch" href="/assets/js/276.9777514a.js"><link rel="prefetch" href="/assets/js/277.c511d92a.js"><link rel="prefetch" href="/assets/js/278.abac46d2.js"><link rel="prefetch" href="/assets/js/279.5f806255.js"><link rel="prefetch" href="/assets/js/28.564c26dd.js"><link rel="prefetch" href="/assets/js/280.b4fa1858.js"><link rel="prefetch" href="/assets/js/281.5c28de7b.js"><link rel="prefetch" href="/assets/js/282.716ae2bd.js"><link rel="prefetch" href="/assets/js/283.39be7d8b.js"><link rel="prefetch" href="/assets/js/284.abc5f110.js"><link rel="prefetch" href="/assets/js/285.65637f3b.js"><link rel="prefetch" href="/assets/js/286.e004360d.js"><link rel="prefetch" href="/assets/js/287.d33c8cd1.js"><link rel="prefetch" href="/assets/js/288.ba9e1859.js"><link rel="prefetch" href="/assets/js/289.f8794ca0.js"><link rel="prefetch" href="/assets/js/29.7aa96265.js"><link rel="prefetch" href="/assets/js/290.eaebdbe2.js"><link rel="prefetch" href="/assets/js/291.bafcfffb.js"><link rel="prefetch" href="/assets/js/292.2a76dceb.js"><link rel="prefetch" href="/assets/js/293.f0ad6ee5.js"><link rel="prefetch" href="/assets/js/294.e6cd28e7.js"><link rel="prefetch" href="/assets/js/295.75c0c32e.js"><link rel="prefetch" href="/assets/js/296.1ba987c7.js"><link rel="prefetch" href="/assets/js/297.df4e6a7c.js"><link rel="prefetch" href="/assets/js/298.aa1d1380.js"><link rel="prefetch" href="/assets/js/299.dfe05cd0.js"><link rel="prefetch" href="/assets/js/3.cce5b785.js"><link rel="prefetch" href="/assets/js/30.c13ddbd0.js"><link rel="prefetch" href="/assets/js/300.19933949.js"><link rel="prefetch" href="/assets/js/301.9fa4f769.js"><link rel="prefetch" href="/assets/js/302.48bb0bca.js"><link rel="prefetch" href="/assets/js/303.60801364.js"><link rel="prefetch" href="/assets/js/304.0ec54d13.js"><link rel="prefetch" href="/assets/js/305.22aeb531.js"><link rel="prefetch" href="/assets/js/306.35173816.js"><link rel="prefetch" href="/assets/js/307.6f9f609e.js"><link rel="prefetch" href="/assets/js/308.69064216.js"><link rel="prefetch" href="/assets/js/309.185a8a53.js"><link rel="prefetch" href="/assets/js/31.e36024e9.js"><link rel="prefetch" href="/assets/js/310.39eacd5b.js"><link rel="prefetch" href="/assets/js/311.94730eab.js"><link rel="prefetch" href="/assets/js/312.372b86fb.js"><link rel="prefetch" href="/assets/js/313.79347503.js"><link rel="prefetch" href="/assets/js/314.df279936.js"><link rel="prefetch" href="/assets/js/315.a4ab6047.js"><link rel="prefetch" href="/assets/js/316.04812ac5.js"><link rel="prefetch" href="/assets/js/317.d4641ea0.js"><link rel="prefetch" href="/assets/js/318.f18535d4.js"><link rel="prefetch" href="/assets/js/319.20dfc68f.js"><link rel="prefetch" href="/assets/js/32.0ee96ddb.js"><link rel="prefetch" href="/assets/js/320.c929eba9.js"><link rel="prefetch" href="/assets/js/321.861a5c0a.js"><link rel="prefetch" href="/assets/js/322.f9e4950e.js"><link rel="prefetch" href="/assets/js/323.59cb4207.js"><link rel="prefetch" href="/assets/js/324.2747c5b1.js"><link rel="prefetch" href="/assets/js/325.b5376734.js"><link rel="prefetch" href="/assets/js/326.73ffe0f8.js"><link rel="prefetch" href="/assets/js/327.33f55ebb.js"><link rel="prefetch" href="/assets/js/328.fdd8e3ef.js"><link rel="prefetch" href="/assets/js/329.cf9000ee.js"><link rel="prefetch" href="/assets/js/33.edbffdcb.js"><link rel="prefetch" href="/assets/js/330.e9eb38bf.js"><link rel="prefetch" href="/assets/js/331.bd442f05.js"><link rel="prefetch" href="/assets/js/332.45c23042.js"><link rel="prefetch" href="/assets/js/333.73153fca.js"><link rel="prefetch" href="/assets/js/334.636199e0.js"><link rel="prefetch" href="/assets/js/335.4d0a6ae8.js"><link rel="prefetch" href="/assets/js/336.97a253e7.js"><link rel="prefetch" href="/assets/js/337.4c9b5efc.js"><link rel="prefetch" href="/assets/js/338.33f94fd1.js"><link rel="prefetch" href="/assets/js/34.4e043e27.js"><link rel="prefetch" href="/assets/js/35.6d49f989.js"><link rel="prefetch" href="/assets/js/36.f5960d39.js"><link rel="prefetch" href="/assets/js/37.74a2a80e.js"><link rel="prefetch" href="/assets/js/38.6269f916.js"><link rel="prefetch" href="/assets/js/39.141e11e0.js"><link rel="prefetch" href="/assets/js/4.64911f15.js"><link rel="prefetch" href="/assets/js/40.1bf4483c.js"><link rel="prefetch" href="/assets/js/41.c347bb50.js"><link rel="prefetch" href="/assets/js/42.e47b1df3.js"><link rel="prefetch" href="/assets/js/43.f7cad0d0.js"><link rel="prefetch" href="/assets/js/44.7a3d1f90.js"><link rel="prefetch" href="/assets/js/45.89306311.js"><link rel="prefetch" href="/assets/js/46.dc47b9d0.js"><link rel="prefetch" href="/assets/js/47.8eed0639.js"><link rel="prefetch" href="/assets/js/48.4f7cbfb6.js"><link rel="prefetch" href="/assets/js/49.e233ecee.js"><link rel="prefetch" href="/assets/js/5.9287b9e3.js"><link rel="prefetch" href="/assets/js/50.1e32c9d8.js"><link rel="prefetch" href="/assets/js/51.5e33bddb.js"><link rel="prefetch" href="/assets/js/52.70a3d801.js"><link rel="prefetch" href="/assets/js/53.82526036.js"><link rel="prefetch" href="/assets/js/54.0fa9bdf5.js"><link rel="prefetch" href="/assets/js/55.ebf4e851.js"><link rel="prefetch" href="/assets/js/56.e488aa6a.js"><link rel="prefetch" href="/assets/js/57.87413c7a.js"><link rel="prefetch" href="/assets/js/58.1c4f47bd.js"><link rel="prefetch" href="/assets/js/59.322d86a2.js"><link rel="prefetch" href="/assets/js/6.a8023fc9.js"><link rel="prefetch" href="/assets/js/60.d473b033.js"><link rel="prefetch" href="/assets/js/61.f8f26d39.js"><link rel="prefetch" href="/assets/js/62.5c5ed58e.js"><link rel="prefetch" href="/assets/js/63.e5abb75c.js"><link rel="prefetch" href="/assets/js/64.a65ce6e6.js"><link rel="prefetch" href="/assets/js/65.dbf5f0c6.js"><link rel="prefetch" href="/assets/js/66.7f4486d3.js"><link rel="prefetch" href="/assets/js/67.0bf55b7c.js"><link rel="prefetch" href="/assets/js/68.990bf5e4.js"><link rel="prefetch" href="/assets/js/69.f4b629ef.js"><link rel="prefetch" href="/assets/js/7.2b62e6bd.js"><link rel="prefetch" href="/assets/js/70.c02ca837.js"><link rel="prefetch" href="/assets/js/71.6ee1373d.js"><link rel="prefetch" href="/assets/js/72.ee903926.js"><link rel="prefetch" href="/assets/js/73.58dba419.js"><link rel="prefetch" href="/assets/js/74.a7d42e7d.js"><link rel="prefetch" href="/assets/js/75.4ffbe225.js"><link rel="prefetch" href="/assets/js/76.f2fcbfcd.js"><link rel="prefetch" href="/assets/js/77.d0c3deb7.js"><link rel="prefetch" href="/assets/js/78.0010c461.js"><link rel="prefetch" href="/assets/js/79.6a70a604.js"><link rel="prefetch" href="/assets/js/8.40ca4fd6.js"><link rel="prefetch" href="/assets/js/80.ae573a8e.js"><link rel="prefetch" href="/assets/js/81.eaf44acc.js"><link rel="prefetch" href="/assets/js/82.e6bb0732.js"><link rel="prefetch" href="/assets/js/83.23310e8c.js"><link rel="prefetch" href="/assets/js/84.54ca505b.js"><link rel="prefetch" href="/assets/js/85.9f70bfbc.js"><link rel="prefetch" href="/assets/js/86.74ddf3fb.js"><link rel="prefetch" href="/assets/js/87.60e01ba5.js"><link rel="prefetch" href="/assets/js/88.1226d6c3.js"><link rel="prefetch" href="/assets/js/89.507975f1.js"><link rel="prefetch" href="/assets/js/9.bce4872d.js"><link rel="prefetch" href="/assets/js/90.f306161d.js"><link rel="prefetch" href="/assets/js/91.3fe96e1e.js"><link rel="prefetch" href="/assets/js/92.bd84fdc8.js"><link rel="prefetch" href="/assets/js/93.0c6dbc9b.js"><link rel="prefetch" href="/assets/js/94.1eec16ff.js"><link rel="prefetch" href="/assets/js/95.84199af6.js"><link rel="prefetch" href="/assets/js/96.3a709dfa.js"><link rel="prefetch" href="/assets/js/97.388f4466.js"><link rel="prefetch" href="/assets/js/98.22f33c4e.js"><link rel="prefetch" href="/assets/js/99.3f832234.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6b2f3ec1.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="Jast blog" class="logo"> <span class="site-name can-hide">Jast blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据" class="dropdown-title"><a href="/bigdata/" class="link-title">大数据</a> <span class="title" style="display:none;">大数据</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/ambari/develop/" class="nav-link">《Ambari自定义开发教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/cdh/" class="nav-link">《CDH教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/clickhouse/" class="nav-link">《ClickHouse教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/hdfs/" class="nav-link">《HDFS教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/dolphinscheduler/" class="nav-link">《DolphinScheduler教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/hbase/" class="nav-link">《Hbase教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/iceberg/" class="nav-link">《Iceberg教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/hive/" class="nav-link">《Hive教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/flume/" class="nav-link">《Flume教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/kafka/" class="nav-link">《Kafka教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/impala/" class="nav-link">《Impala教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/hue/" class="nav-link">《Hue教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/spark/" class="nav-link">《Spark教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/flink/" class="nav-link">《Flink教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/phoenix/" class="nav-link">《Phoenix教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/elasticsearch/" class="nav-link">《ElasticSearch教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/kylin/" class="nav-link">《Kylin教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/storm/" class="nav-link">《Storm教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/yarn/" class="nav-link">《Yarn教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/presto/" class="nav-link">《Presto教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/graph/" class="nav-link">《图数据库教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/kerberos/" class="nav-link">《Kerberos教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/maxwell/" class="nav-link">《Maxwell教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/minio/" class="nav-link">《MinIO教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/datax/" class="nav-link">《DataX教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/superset/" class="nav-link">《Superset教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/iotdb/" class="nav-link">《IOTDB教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/bigdata/other/" class="nav-link">《大数据相关》笔记</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="人工智能" class="dropdown-title"><a href="/ai/" class="link-title">人工智能</a> <span class="title" style="display:none;">人工智能</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/paddlenlp/" class="nav-link">《PaddleNLP教程》笔记</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="运维" class="dropdown-title"><a href="/yunwei/" class="link-title">运维</a> <span class="title" style="display:none;">运维</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/nginx/" class="nav-link">《Nginx教程》笔记</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><a href="/java/" class="link-title">Java</a> <span class="title" style="display:none;">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/java/" class="nav-link">《Java技术文档》</a></li><li class="dropdown-item"><!----> <a href="/note/maven/" class="nav-link">《Maven教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/idea/" class="nav-link">《IDEA使用教程》</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f2a556/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/pages/aea6571b7a8bae86/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/pages/2d615df9a36a98ed/" class="nav-link">心情杂货</a></li><li class="dropdown-item"><!----> <a href="/pages/baaa02/" class="nav-link">实用技巧</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/head.jpeg"> <div class="blogger-info"><h3>Jast-zsh</h3> <span>如果你知道你要去哪里，全世界都会给你让路。</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据" class="dropdown-title"><a href="/bigdata/" class="link-title">大数据</a> <span class="title" style="display:none;">大数据</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/ambari/develop/" class="nav-link">《Ambari自定义开发教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/cdh/" class="nav-link">《CDH教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/clickhouse/" class="nav-link">《ClickHouse教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/hdfs/" class="nav-link">《HDFS教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/dolphinscheduler/" class="nav-link">《DolphinScheduler教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/hbase/" class="nav-link">《Hbase教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/iceberg/" class="nav-link">《Iceberg教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/hive/" class="nav-link">《Hive教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/flume/" class="nav-link">《Flume教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/kafka/" class="nav-link">《Kafka教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/impala/" class="nav-link">《Impala教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/hue/" class="nav-link">《Hue教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/spark/" class="nav-link">《Spark教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/flink/" class="nav-link">《Flink教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/phoenix/" class="nav-link">《Phoenix教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/elasticsearch/" class="nav-link">《ElasticSearch教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/kylin/" class="nav-link">《Kylin教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/storm/" class="nav-link">《Storm教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/yarn/" class="nav-link">《Yarn教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/presto/" class="nav-link">《Presto教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/graph/" class="nav-link">《图数据库教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/kerberos/" class="nav-link">《Kerberos教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/maxwell/" class="nav-link">《Maxwell教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/minio/" class="nav-link">《MinIO教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/datax/" class="nav-link">《DataX教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/superset/" class="nav-link">《Superset教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/iotdb/" class="nav-link">《IOTDB教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/bigdata/other/" class="nav-link">《大数据相关》笔记</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="人工智能" class="dropdown-title"><a href="/ai/" class="link-title">人工智能</a> <span class="title" style="display:none;">人工智能</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/paddlenlp/" class="nav-link">《PaddleNLP教程》笔记</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="运维" class="dropdown-title"><a href="/yunwei/" class="link-title">运维</a> <span class="title" style="display:none;">运维</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/nginx/" class="nav-link">《Nginx教程》笔记</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><a href="/java/" class="link-title">Java</a> <span class="title" style="display:none;">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/java/" class="nav-link">《Java技术文档》</a></li><li class="dropdown-item"><!----> <a href="/note/maven/" class="nav-link">《Maven教程》笔记</a></li><li class="dropdown-item"><!----> <a href="/note/idea/" class="nav-link">《IDEA使用教程》</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f2a556/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/pages/aea6571b7a8bae86/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/pages/2d615df9a36a98ed/" class="nav-link">心情杂货</a></li><li class="dropdown-item"><!----> <a href="/pages/baaa02/" class="nav-link">实用技巧</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/pages/6b81b0/" class="sidebar-link">FlinkClient使用Iceberg</a></li><li><a href="/pages/e731cc/" class="sidebar-link">Iceberg基于Hadoop存储数据格式介绍</a></li><li><a href="/pages/1c690d/" class="sidebar-link">Kafka数据写入Iceberg</a></li><li><a href="/pages/f4794d/" class="sidebar-link">Flink代码读写Iceberg</a></li><li><a href="/pages/d3710b/" class="sidebar-link">数据湖Iceberg-简介(1)</a></li><li><a href="/pages/ded150/" class="sidebar-link">数据湖Iceberg-存储结构(2)</a></li><li><a href="/pages/9a96a6/" class="sidebar-link">数据湖Iceberg-Hive集成Iceberg(3)</a></li><li><a href="/pages/592494/" aria-current="page" class="active sidebar-link">数据湖Iceberg-SparkSQL集成(4)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/592494/#一、环境准备" class="sidebar-link">一、环境准备</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/592494/#安装spark" class="sidebar-link">安装Spark</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/592494/#二、spark配置catalog" class="sidebar-link">二、Spark配置Catalog</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/592494/#_2-1在配置文件中添加hivecatalog与hadoopcatalog配置-一劳永逸" class="sidebar-link">2.1在配置文件中添加HiveCatalog与HadoopCatalog配置（一劳永逸）</a></li><li class="sidebar-sub-header level3"><a href="/pages/592494/#_2-2使用spark-sql连接hive-catalog" class="sidebar-link">2.2使用spark-sql连接Hive Catalog</a></li><li class="sidebar-sub-header level3"><a href="/pages/592494/#_2-3使用spark-sql连接hadoop-catalog" class="sidebar-link">2.3使用spark-sql连接Hadoop Catalog</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/592494/#三、sql操作" class="sidebar-link">三、SQL操作</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/592494/#_3-1-创建表" class="sidebar-link">3.1 创建表</a></li><li class="sidebar-sub-header level4"><a href="/pages/592494/#创建分区表" class="sidebar-link">创建分区表</a></li><li class="sidebar-sub-header level5"><a href="/pages/592494/#分区表" class="sidebar-link">分区表</a></li><li class="sidebar-sub-header level5"><a href="/pages/592494/#创建隐藏分区表" class="sidebar-link">创建隐藏分区表</a></li><li class="sidebar-sub-header level5"><a href="/pages/592494/#使用ctas-create-table-xxx-as-select-语法建表" class="sidebar-link">使用CTAS(Create Table xxx As Select)语法建表</a></li><li class="sidebar-sub-header level5"><a href="/pages/592494/#使用replace-table建表" class="sidebar-link">使用Replace Table建表</a></li><li class="sidebar-sub-header level3"><a href="/pages/592494/#_3-2删除表" class="sidebar-link">3.2删除表</a></li><li class="sidebar-sub-header level3"><a href="/pages/592494/#_3-3修改表" class="sidebar-link">3.3修改表</a></li><li class="sidebar-sub-header level4"><a href="/pages/592494/#修改表名-不支持修改hadoopcatalog的表名" class="sidebar-link">修改表名(不支持修改HadoopCatalog的表名)</a></li><li class="sidebar-sub-header level4"><a href="/pages/592494/#修改表属性" class="sidebar-link">修改表属性</a></li><li class="sidebar-sub-header level4"><a href="/pages/592494/#删除表属性" class="sidebar-link">删除表属性</a></li><li class="sidebar-sub-header level4"><a href="/pages/592494/#添加列" class="sidebar-link">添加列</a></li><li class="sidebar-sub-header level4"><a href="/pages/592494/#修改列" class="sidebar-link">修改列</a></li><li class="sidebar-sub-header level5"><a href="/pages/592494/#修改列名" class="sidebar-link">修改列名</a></li><li class="sidebar-sub-header level5"><a href="/pages/592494/#alter-column修改类型-只允许安全的转换" class="sidebar-link">Alter Column修改类型（只允许安全的转换）</a></li><li class="sidebar-sub-header level5"><a href="/pages/592494/#alter-column-修改列的注释" class="sidebar-link">Alter Column 修改列的注释</a></li><li class="sidebar-sub-header level5"><a href="/pages/592494/#alter-column修改列的顺序" class="sidebar-link">Alter Column修改列的顺序</a></li><li class="sidebar-sub-header level5"><a href="/pages/592494/#alter-column修改列是否允许为null" class="sidebar-link">Alter Column修改列是否允许为null</a></li><li class="sidebar-sub-header level4"><a href="/pages/592494/#删除列" class="sidebar-link">删除列</a></li><li class="sidebar-sub-header level4"><a href="/pages/592494/#添加分区-spark3-需要在配置文件中扩展" class="sidebar-link">添加分区（spark3,需要在配置文件中扩展）</a></li><li class="sidebar-sub-header level4"><a href="/pages/592494/#删除分区-spark3-需要配置扩展" class="sidebar-link">删除分区（Spark3，需要配置扩展）</a></li><li class="sidebar-sub-header level4"><a href="/pages/592494/#修改分区-spark3-需要配置扩展" class="sidebar-link">修改分区（Spark3，需要配置扩展）</a></li><li class="sidebar-sub-header level4"><a href="/pages/592494/#修改表的写入顺序" class="sidebar-link">修改表的写入顺序</a></li><li class="sidebar-sub-header level4"><a href="/pages/592494/#按分区并行写入" class="sidebar-link">按分区并行写入</a></li><li class="sidebar-sub-header level3"><a href="/pages/592494/#_3-4插入数据" class="sidebar-link">3.4插入数据</a></li><li class="sidebar-sub-header level4"><a href="/pages/592494/#insert-into" class="sidebar-link">INSERT INTO</a></li><li class="sidebar-sub-header level4"><a href="/pages/592494/#merge-into-行级更新" class="sidebar-link">MERGE INTO 行级更新</a></li><li class="sidebar-sub-header level3"><a href="/pages/592494/#_3-5查询数据" class="sidebar-link">3.5查询数据</a></li><li class="sidebar-sub-header level4"><a href="/pages/592494/#普通查询" class="sidebar-link">普通查询</a></li><li class="sidebar-sub-header level4"><a href="/pages/592494/#查询元数据" class="sidebar-link">查询元数据</a></li><li class="sidebar-sub-header level3"><a href="/pages/592494/#_3-6存储过程" class="sidebar-link">3.6存储过程</a></li><li class="sidebar-sub-header level4"><a href="/pages/592494/#语法" class="sidebar-link">语法</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/592494/#四、dataframe操作" class="sidebar-link">四、DataFrame操作</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/592494/#_4-1环境准备" class="sidebar-link">4.1环境准备</a></li><li class="sidebar-sub-header level4"><a href="/pages/592494/#创建maven工程-pom-xml文件内容" class="sidebar-link">创建Maven工程，pom.xml文件内容</a></li><li class="sidebar-sub-header level4"><a href="/pages/592494/#代码中配置catalog" class="sidebar-link">代码中配置Catalog</a></li><li class="sidebar-sub-header level3"><a href="/pages/592494/#_4-2读取表" class="sidebar-link">4.2读取表</a></li><li class="sidebar-sub-header level4"><a href="/pages/592494/#加载表" class="sidebar-link">加载表</a></li><li class="sidebar-sub-header level4"><a href="/pages/592494/#时间旅行-查询指定时间戳之前的数据" class="sidebar-link">时间旅行：查询指定时间戳之前的数据</a></li><li class="sidebar-sub-header level4"><a href="/pages/592494/#时间旅行-查询指定快照-id-的数据" class="sidebar-link">时间旅行：查询指定快照 ID 的数据</a></li><li class="sidebar-sub-header level4"><a href="/pages/592494/#读取指定两个快照-id-之间增量数据" class="sidebar-link">读取指定两个快照 ID 之间增量数据</a></li><li class="sidebar-sub-header level3"><a href="/pages/592494/#_4-3检查表" class="sidebar-link">4.3检查表</a></li><li class="sidebar-sub-header level4"><a href="/pages/592494/#查询表元数据" class="sidebar-link">查询表元数据</a></li><li class="sidebar-sub-header level4"><a href="/pages/592494/#指定快照id查询元数据" class="sidebar-link">指定快照ID查询元数据</a></li><li class="sidebar-sub-header level3"><a href="/pages/592494/#_4-4写入表" class="sidebar-link">4.4写入表</a></li><li class="sidebar-sub-header level4"><a href="/pages/592494/#创建替换表结构并写入数据" class="sidebar-link">创建替换表结构并写入数据</a></li><li class="sidebar-sub-header level4"><a href="/pages/592494/#append添加数据" class="sidebar-link">append添加数据</a></li><li class="sidebar-sub-header level4"><a href="/pages/592494/#动态分区覆盖" class="sidebar-link">动态分区覆盖</a></li><li class="sidebar-sub-header level4"><a href="/pages/592494/#静态分区覆盖" class="sidebar-link">静态分区覆盖</a></li><li class="sidebar-sub-header level3"><a href="/pages/592494/#_4-5维护表" class="sidebar-link">4.5维护表</a></li><li class="sidebar-sub-header level4"><a href="/pages/592494/#获取table对象" class="sidebar-link">获取Table对象</a></li><li class="sidebar-sub-header level4"><a href="/pages/592494/#快照过期清理" class="sidebar-link">快照过期清理</a></li><li class="sidebar-sub-header level4"><a href="/pages/592494/#删除无效文件" class="sidebar-link">删除无效文件</a></li><li class="sidebar-sub-header level4"><a href="/pages/592494/#合并小文件" class="sidebar-link">合并小文件</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/592494/#五、整体代码" class="sidebar-link">五、整体代码</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/592494/#代码" class="sidebar-link">代码</a></li><li class="sidebar-sub-header level3"><a href="/pages/592494/#配置文件" class="sidebar-link">配置文件</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/592494/#可能遇到的问题" class="sidebar-link">可能遇到的问题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/592494/#启动spark-sql异常a-read-only-user-or-a-user-in-a-read-only-database-is-not-permitted-to-disable-read-only-mode-on-a-connection" class="sidebar-link">启动spark-sql异常 A read-only user or a user in a read-only database is not permitted to disable read-only mode on a connection.</a></li></ul></li></ul></li><li><a href="/pages/12fe6d/" class="sidebar-link">数据湖Iceberg-FlinkSQL集成(5)</a></li><li><a href="/pages/edf0ba/" class="sidebar-link">数据湖Iceberg-FlinkSQL-kafka类型表数据无法成功写入(6)</a></li><li><a href="/pages/571843/" class="sidebar-link">数据湖Iceberg-Flink DataFrame集成(7)</a></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/categories/?category=%E3%80%8AIceberg%E6%95%99%E7%A8%8B%E3%80%8B%E7%AC%94%E8%AE%B0" title="分类" data-v-06225672>《Iceberg教程》笔记</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://datamining.blog.csdn.net/" target="_blank" title="作者" class="beLink" data-v-06225672>Jast-zsh</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-04-24</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">数据湖Iceberg-SparkSQL集成(4)<!----></h1>  <div class="theme-vdoing-content content__default"><p>[toc]</p> <p><a href="https://www.hadoop.wiki/pages/d3710b" target="_blank" rel="noopener noreferrer">数据湖Iceberg-简介(1)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a href="https://www.hadoop.wiki/pages/ded150/" target="_blank" rel="noopener noreferrer">数据湖Iceberg-存储结构(2)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a href="https://www.hadoop.wiki/pages/9a96a6/" target="_blank" rel="noopener noreferrer">数据湖Iceberg-Hive集成Iceberg(3)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a href="https://www.hadoop.wiki/pages/592494/" target="_blank" rel="noopener noreferrer">数据湖Iceberg-SparkSQL集成(4)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a href="https://www.hadoop.wiki/pages/12fe6d/" target="_blank" rel="noopener noreferrer">数据湖Iceberg-FlinkSQL集成(5)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a href="https://www.hadoop.wiki/pages/edf0ba/" target="_blank" rel="noopener noreferrer">数据湖Iceberg-FlinkSQL-kafka类型表数据无法成功写入(6)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a href="https://www.hadoop.wiki/pages/571843/" target="_blank" rel="noopener noreferrer">数据湖Iceberg-Flink DataFrame集成(7)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h1 id="数据湖iceberg-sparksql集成"><a href="#数据湖iceberg-sparksql集成" class="header-anchor">#</a> 数据湖Iceberg-SparkSQL集成</h1> <h2 id="一、环境准备"><a href="#一、环境准备" class="header-anchor">#</a> 一、环境准备</h2> <p>Spark安装包下载地址：</p> <p><a href="https://mirrors.huaweicloud.com/apache/spark" target="_blank" rel="noopener noreferrer">https://mirrors.huaweicloud.com/apache/spark<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>iceberg官网：</p> <p><a href="https://iceberg.apache.org/releases/#110-release" target="_blank" rel="noopener noreferrer">https://iceberg.apache.org/releases/#110-release<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="安装spark"><a href="#安装spark" class="header-anchor">#</a> 安装Spark</h3> <p><strong>1.Spark与Iceberg的版本对应关系如下</strong></p> <table><thead><tr><th>Spark 版本</th> <th>Iceberg 版本</th></tr></thead> <tbody><tr><td>2.4</td> <td>0.7.0-incubating – 1.1.0</td></tr> <tr><td>3</td> <td>0.9.0 – 1.0.0</td></tr> <tr><td>3.1</td> <td>0.12.0 – 1.1.0</td></tr> <tr><td>3.2</td> <td>0.13.0 – 1.1.0</td></tr> <tr><td>3.3</td> <td>0.14.0 – 1.1.0</td></tr></tbody></table> <p><strong>2.上传并解压Spark安装包</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> spark-3.2.1-bin-hadoop2.7.tgz 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>修改目录名为<code>spark-3.2.1</code></p> <p><strong>3.配置环境变量</strong></p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>sudo vim <span class="token operator">/</span>etc<span class="token operator">/</span>profile<span class="token punctuation">.</span>d<span class="token operator">/</span>spark<span class="token punctuation">.</span>sh

export SPARK_HOME<span class="token operator">=</span><span class="token operator">/</span>opt<span class="token operator">/</span>spark<span class="token operator">-</span><span class="token number">3.2</span><span class="token number">.1</span>
export PATH<span class="token operator">=</span>$PATH:$SPARK_HOME<span class="token operator">/</span>bin

source <span class="token operator">/</span>etc<span class="token operator">/</span>profile<span class="token punctuation">.</span>d<span class="token operator">/</span>spark<span class="token punctuation">.</span>sh
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>4.拷贝iceberg的jar包到Spark的jars目录</strong>
iceberg-sparkjar包下载地址：</p> <p><a href="https://search.maven.org/remotecontent?filepath=org/apache/iceberg/iceberg-spark-runtime-3.2_2.12/1.2.0/iceberg-spark-runtime-3.2_2.12-1.2.0.jar" target="_blank" rel="noopener noreferrer">https://search.maven.org/remotecontent?filepath=org/apache/iceberg/iceberg-spark-runtime-3.2_2.12/1.2.0/iceberg-spark-runtime-3.2_2.12-1.2.0.jar<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">cp</span> iceberg-spark-runtime-3.2_2.12-1.2.0.jar <span class="token variable">$SPARK_HOME</span>/jars
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>5.修改spark目录为hdfs用户权限</strong></p> <blockquote><p>平时使用hdfs提交任务,不设置一会用hdfs用户启动spark-sql会报错</p></blockquote> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">chown</span> <span class="token parameter variable">-R</span> hdfs.hdfs spark-3.2.1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="二、spark配置catalog"><a href="#二、spark配置catalog" class="header-anchor">#</a> 二、Spark配置Catalog</h2> <p>Spark中支持两种Catalog的设置：hive和hadoop，Hive Catalog就是Iceberg表存储使用Hive默认的数据路径，Hadoop Catalog需要指定Iceberg格式表存储路径。</p> <p>官方文档：<a href="https://iceberg.apache.org/docs/1.1.0/getting-started/" target="_blank" rel="noopener noreferrer">https://iceberg.apache.org/docs/1.1.0/getting-started/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="_2-1在配置文件中添加hivecatalog与hadoopcatalog配置-一劳永逸"><a href="#_2-1在配置文件中添加hivecatalog与hadoopcatalog配置-一劳永逸" class="header-anchor">#</a> 2.1在配置文件中添加HiveCatalog与HadoopCatalog配置（一劳永逸）</h3> <p>修改<code>$spark/conf/spark-defaults.conf</code>配置文件，添加以下内容</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">spark.sql.catalog.hive_prod</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.iceberg.spark.SparkCatalog</span>
<span class="token key attr-name">spark.sql.catalog.hive_prod.type</span><span class="token punctuation">=</span><span class="token value attr-value">hive</span>
<span class="token key attr-name">spark.sql.catalog.hive_prod.uri</span><span class="token punctuation">=</span><span class="token value attr-value">thrift://bigdata-24-199:9083</span>

<span class="token key attr-name">spark.sql.catalog.hadoop_prod</span> <span class="token punctuation">=</span> <span class="token value attr-value">org.apache.iceberg.spark.SparkCatalog</span>
<span class="token key attr-name">spark.sql.catalog.hadoop_prod.type</span> <span class="token punctuation">=</span> <span class="token value attr-value">hadoop</span>
<span class="token key attr-name">spark.sql.catalog.hadoop_prod.warehouse</span> <span class="token punctuation">=</span> <span class="token value attr-value">hdfs://bigdata-24-198:8020/warehouse/spark-iceberg</span>

<span class="token comment"># 添加分区需要使用该配置</span>
<span class="token key attr-name">spark.sql.extensions</span> <span class="token punctuation">=</span> <span class="token value attr-value">org.apache.iceberg.spark.extensions.IcebergSparkSessionExtensions</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>直接启动spark-sql就可以使用配置的HiveCatalog和HadoopCatalog了</p> <h3 id="_2-2使用spark-sql连接hive-catalog"><a href="#_2-2使用spark-sql连接hive-catalog" class="header-anchor">#</a> 2.2使用spark-sql连接Hive Catalog</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> /opt/spark-3.2.1
spark-sql <span class="token punctuation">\</span>
<span class="token parameter variable">--conf</span> <span class="token assign-left variable">spark.sql.catalog.hive_prod</span><span class="token operator">=</span>org.apache.iceberg.spark.SparkCatalog <span class="token punctuation">\</span>
<span class="token parameter variable">--conf</span> <span class="token assign-left variable">spark.sql.catalog.hive_prod.type</span><span class="token operator">=</span>hive <span class="token punctuation">\</span>
<span class="token parameter variable">--conf</span> <span class="token assign-left variable">spark.sql.catalog.hive_prod.uri</span><span class="token operator">=</span>thrift://bigdata-24-199:9083
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><table><thead><tr><th>配置</th> <th>含义</th></tr></thead> <tbody><tr><td>hive_prod</td> <td>我们要创建Hive catalog名称</td></tr> <tr><td>spark.sql.catalog.hive_prod.uri</td> <td>hive-site.xml配置的hive.metastore.uris值</td></tr></tbody></table> <blockquote><p>执行该命令会在之前的当前目录生成一个<code>metastore_db</code>目录和<code>derby.log</code>日志文件</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>-rw-r--r-- <span class="token number">1</span> hdfs hadoop  <span class="token number">659</span> Apr <span class="token number">13</span> <span class="token number">16</span>:42 derby.log
drwxr-xr-x <span class="token number">5</span> hdfs hadoop <span class="token number">4096</span> Apr <span class="token number">13</span> <span class="token number">16</span>:42 metastore_db
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></blockquote> <p><strong>基础使用:</strong></p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment"># 使用hive_prod catalog</span>
spark<span class="token operator">-</span><span class="token keyword">sql</span><span class="token operator">&gt;</span> <span class="token keyword">use</span> hive_prod<span class="token punctuation">;</span>
<span class="token comment"># 进入default数据库</span>
spark<span class="token operator">-</span><span class="token keyword">sql</span><span class="token operator">&gt;</span> <span class="token keyword">use</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
<span class="token keyword">Time</span> taken: <span class="token number">0.104</span> seconds
<span class="token comment"># 创建表</span>
spark<span class="token operator">-</span><span class="token keyword">sql</span><span class="token operator">&gt;</span> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> hive_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample2 <span class="token punctuation">(</span>
         <span class="token operator">&gt;</span>     id <span class="token keyword">bigint</span> <span class="token keyword">COMMENT</span> <span class="token string">'unique id'</span><span class="token punctuation">,</span>
         <span class="token operator">&gt;</span>     <span class="token keyword">data</span> string<span class="token punctuation">)</span>
         <span class="token operator">&gt;</span> <span class="token keyword">USING</span> iceberg<span class="token punctuation">;</span>
<span class="token keyword">Time</span> taken: <span class="token number">3.271</span> seconds
<span class="token comment"># 查看表，这里可以看到hive中的表</span>
spark<span class="token operator">-</span><span class="token keyword">sql</span><span class="token operator">&gt;</span> <span class="token keyword">show</span> <span class="token keyword">tables</span><span class="token punctuation">;</span>
sample2
<span class="token keyword">Time</span> taken: <span class="token number">0.729</span> seconds<span class="token punctuation">,</span> Fetched <span class="token number">9</span> <span class="token keyword">row</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token comment"># 写入数据</span>
spark<span class="token operator">-</span><span class="token keyword">sql</span><span class="token operator">&gt;</span> <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> hive_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample2 <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'数据1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'数据2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">Time</span> taken: <span class="token number">6.256</span> seconds
<span class="token comment"># 查看数据</span>
spark<span class="token operator">-</span><span class="token keyword">sql</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span>  hive_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample2<span class="token punctuation">;</span>
<span class="token number">1</span>       数据<span class="token number">1</span>
<span class="token number">2</span>       数据<span class="token number">2</span>
<span class="token keyword">Time</span> taken: <span class="token number">2.117</span> seconds<span class="token punctuation">,</span> Fetched <span class="token number">2</span> <span class="token keyword">row</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="_2-3使用spark-sql连接hadoop-catalog"><a href="#_2-3使用spark-sql连接hadoop-catalog" class="header-anchor">#</a> 2.3使用spark-sql连接Hadoop Catalog</h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /opt/spark-3.2.1
spark-sql <span class="token punctuation">\</span>
<span class="token parameter variable">--conf</span> <span class="token assign-left variable">spark.sql.catalog.hadoop_prod</span><span class="token operator">=</span>org.apache.iceberg.spark.SparkCatalog <span class="token punctuation">\</span>
<span class="token parameter variable">--conf</span> <span class="token assign-left variable">spark.sql.catalog.hadoop_prod.type</span><span class="token operator">=</span>hadoop <span class="token punctuation">\</span>
<span class="token parameter variable">--conf</span> <span class="token assign-left variable">spark.sql.catalog.hadoop_prod.warehouse</span><span class="token operator">=</span>hdfs://bigdata-24-198:8020/warehouse/spark-iceberg
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="三、sql操作"><a href="#三、sql操作" class="header-anchor">#</a> 三、SQL操作</h2> <p>后面统一使用在2.1章节配置文件添加配置方式演示</p> <h3 id="_3-1-创建表"><a href="#_3-1-创建表" class="header-anchor">#</a> 3.1 创建表</h3> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment"># 使用catalog hadoop_prod</span>
<span class="token keyword">use</span> hadoop_prod<span class="token punctuation">;</span>
<span class="token comment"># 创建数据库，默认没有</span>
<span class="token keyword">create</span> <span class="token keyword">database</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
<span class="token comment"># 进入数据库</span>
<span class="token keyword">use</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
<span class="token comment"># 创建表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample1 <span class="token punctuation">(</span>
    id <span class="token keyword">bigint</span> <span class="token keyword">COMMENT</span> <span class="token string">'unique id'</span><span class="token punctuation">,</span>
    <span class="token keyword">data</span> string<span class="token punctuation">)</span>
<span class="token keyword">USING</span> iceberg
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li>PARTITIONED BY (partition-expressions) ：配置分区</li> <li>LOCATION '(fully-qualified-uri)' ：指定表路径</li> <li>COMMENT 'table documentation' ：配置表备注</li> <li>TBLPROPERTIES ('key'='value', ...) ：配置表属性</li></ul> <p>表属性：<a href="https://iceberg.apache.org/docs/latest/configuration/" target="_blank" rel="noopener noreferrer">https://iceberg.apache.org/docs/latest/configuration/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>对Iceberg表的每次更改都会生成一个新的元数据文件（json文件）以提供原子性。默认情况下，旧元数据文件作为历史文件保存不会删除。</p> <p>如果要自动清除元数据文件，在表属性中设置write.metadata.delete-after-commit.enabled=true。这将保留一些元数据文件（直到write.metadata.previous-versions-max），并在每个新创建的元数据文件之后删除旧的元数据文件。</p> <h4 id="创建分区表"><a href="#创建分区表" class="header-anchor">#</a> 创建分区表</h4> <h5 id="分区表"><a href="#分区表" class="header-anchor">#</a> 分区表</h5> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample2 <span class="token punctuation">(</span>
    id <span class="token keyword">bigint</span><span class="token punctuation">,</span>
    <span class="token keyword">data</span> string<span class="token punctuation">,</span>
    category string<span class="token punctuation">)</span>
<span class="token keyword">USING</span> iceberg
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span>category<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>看看插入数据数据存储结构如何</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample2 <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'数据1'</span><span class="token punctuation">,</span><span class="token string">'分类1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'数据2'</span><span class="token punctuation">,</span><span class="token string">'分类1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'数据3'</span><span class="token punctuation">,</span><span class="token string">'分类2'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>查看数据存储目录</p> <p><img src="https://s2.loli.net/2023/04/24/vystOe9MRYNJlG1.png" alt="image-20230414113200150"></p> <p>查看元数据目录</p> <p><img src="https://s2.loli.net/2023/04/24/DH7gXwYcr2GOPRL.png" alt="image-20230414113213367"></p> <p>发现会根据分区指定字段按照目录存储</p> <h5 id="创建隐藏分区表"><a href="#创建隐藏分区表" class="header-anchor">#</a> 创建隐藏分区表</h5> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample3 <span class="token punctuation">(</span>
    id <span class="token keyword">bigint</span><span class="token punctuation">,</span>
    <span class="token keyword">data</span> string<span class="token punctuation">,</span>
    category string<span class="token punctuation">,</span>
    ts <span class="token keyword">timestamp</span><span class="token punctuation">)</span>
<span class="token keyword">USING</span> iceberg
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span>bucket<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">,</span> days<span class="token punctuation">(</span>ts<span class="token punctuation">)</span><span class="token punctuation">,</span> category<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>支持的转换有:</p> <ul><li><p>years(ts):按年划分</p></li> <li><p>months(ts):按月划分</p></li> <li><p>days(ts)或date(ts):等效于dateint分区</p></li> <li><p>hours(ts)或date_hour(ts):等效于dateint和hour分区</p></li> <li><p>bucket(N, col):按哈希值划分mod N个桶</p></li> <li><p>truncate(L, col):按截断为L的值划分,字符串被截断为给定的长度,整型和长型截断为bin: truncate(10, i)生成分区0,10,20,30，…</p></li></ul> <p>看看插入数据存储结构如何</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>INSERT INTO hadoop_prod.default.sample3 VALUES(1,'数据1','分类1',cast(from_unixtime(1649826749) as timestamp)),
(2,'数据2','分类1',cast(from_unixtime(1681362749) as timestamp)),
(3,'数据3','分类2',cast(from_unixtime(1681449149) as timestamp));
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>查看数据存储目录</p> <p><img src="https://s2.loli.net/2023/04/24/TCylkGRSD4vnKV7.png" alt="image-20230414131744991"></p> <p>发现，目录顺序与创建隐藏分区书序相同</p> <h5 id="使用ctas-create-table-xxx-as-select-语法建表"><a href="#使用ctas-create-table-xxx-as-select-语法建表" class="header-anchor">#</a> 使用CTAS(Create Table xxx As Select)语法建表</h5> <blockquote><p><strong>新表会包含源表数据</strong></p></blockquote> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample4
<span class="token keyword">USING</span> iceberg
<span class="token keyword">AS</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">from</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample3
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>注意：使用CTAS方法创建，如果新表不指定分区字段默认创建的表是不带分区字段的。表属性也相同</p></blockquote> <p>所以，创建新表时需要带上分区、属性配置：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample5
<span class="token keyword">USING</span> iceberg
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span>bucket<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">,</span> hours<span class="token punctuation">(</span>ts<span class="token punctuation">)</span><span class="token punctuation">,</span> category<span class="token punctuation">)</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'key'</span><span class="token operator">=</span><span class="token string">'value'</span><span class="token punctuation">)</span>
<span class="token keyword">AS</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">from</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample3
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h5 id="使用replace-table建表"><a href="#使用replace-table建表" class="header-anchor">#</a> 使用Replace Table建表</h5> <blockquote><p><strong>新表会包含源表数据</strong></p></blockquote> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">REPLACE</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample5
<span class="token keyword">USING</span> iceberg
<span class="token keyword">AS</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">from</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample3<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>同样使用Replace Table替换表结构也不会带分区字段和表属性</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">REPLACE</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample5
<span class="token keyword">USING</span> iceberg
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span>category<span class="token punctuation">)</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'key'</span><span class="token operator">=</span><span class="token string">'value'</span><span class="token punctuation">)</span>
<span class="token keyword">AS</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">from</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample3<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>如果Replace的表不存在则会报错，需要使用<code>CREATE OR REPLACE TABLE</code>语法创建即可</p> <blockquote><p>分区和表属性同样不会带进去</p></blockquote> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample6
<span class="token keyword">USING</span> iceberg
<span class="token keyword">AS</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">from</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample3
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_3-2删除表"><a href="#_3-2删除表" class="header-anchor">#</a> 3.2删除表</h3> <p>对于HadoopCatalog而言，运行DROP TABLE将从catalog中删除表并删除表内容(整个存储目录均删除了)。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment"># 创建表</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample15 <span class="token punctuation">(</span>
    id <span class="token keyword">bigint</span> <span class="token keyword">COMMENT</span> <span class="token string">'unique id'</span><span class="token punctuation">,</span>
    <span class="token keyword">data</span> string<span class="token punctuation">)</span>
<span class="token keyword">USING</span> iceberg<span class="token punctuation">;</span>

<span class="token comment"># 添加数据</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample15 <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># 删除表</span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample15<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>对于HiveCatalog而言：</p> <ul><li>在0.14之前，运行DROP TABLE将从catalog中删除表并删除表内容。</li> <li>从0.14开始，DROP TABLE只会从catalog中删除表，不会删除数据。为了删除表内容，应该使用DROP table PURGE。</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> hive_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample16 <span class="token punctuation">(</span>
    id <span class="token keyword">bigint</span> <span class="token keyword">COMMENT</span> <span class="token string">'unique id'</span><span class="token punctuation">,</span>
    <span class="token keyword">data</span> string<span class="token punctuation">)</span>
<span class="token keyword">USING</span> iceberg<span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> hive_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample16 <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>添加数据之后，hdfs文件分布</p> <p><img src="https://s2.loli.net/2023/04/24/Qn4bpDqgIYBKUaP.png" alt="image-20230414170940462"></p> <p><strong>删除表</strong></p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> hive_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample16<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>此时在spark-sql中<code>show tables</code>已经看不到表名了,但是在hdfs中表的数据都存在</p> <p><strong>删除表和HDFS上的数据</strong></p> <blockquote><p>我测试时候HDFS数据也没有删除~</p> <p>记录一下,后续再验证 hdfs dfs -ls /warehouse/tablespace/managed/hive/sample16/metadata</p></blockquote> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> hive_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample16 <span class="token keyword">PURGE</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_3-3修改表"><a href="#_3-3修改表" class="header-anchor">#</a> 3.3修改表</h3> <p>Iceberg在Spark 3中完全支持ALTER TABLE，包括:</p> <ul><li>重命名表</li> <li>设置或删除表属性</li> <li>添加、删除和重命名列</li> <li>添加、删除和重命名嵌套字段</li> <li>重新排序顶级列和嵌套结构字段</li> <li>扩大int、float和decimal字段的类型</li> <li>将必选列变为可选列</li></ul> <p>此外，还可以使用SQL扩展来添加对分区演变的支持和设置表的写顺序。</p> <p><strong>创建一个表做验证使用</strong></p> <p>hive catalog 表</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> hive_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample_alert <span class="token punctuation">(</span>
    id <span class="token keyword">bigint</span> <span class="token keyword">COMMENT</span> <span class="token string">'unique id'</span><span class="token punctuation">,</span>
    <span class="token keyword">data</span> string<span class="token punctuation">)</span>
<span class="token keyword">USING</span> iceberg<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>hadoop catalog 表</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample_alert <span class="token punctuation">(</span>
    id <span class="token keyword">bigint</span> <span class="token keyword">COMMENT</span> <span class="token string">'unique id'</span><span class="token punctuation">,</span>
    <span class="token keyword">data</span> string<span class="token punctuation">)</span>
<span class="token keyword">USING</span> iceberg<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="修改表名-不支持修改hadoopcatalog的表名"><a href="#修改表名-不支持修改hadoopcatalog的表名" class="header-anchor">#</a> 修改表名(不支持修改HadoopCatalog的表名)</h4> <blockquote><p>修改表名后，存储在HDFS的目录名是不变的</p></blockquote> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hive_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample_alert <span class="token keyword">RENAME</span> <span class="token keyword">TO</span> hive_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample_alert2<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="修改表属性"><a href="#修改表属性" class="header-anchor">#</a> 修改表属性</h4> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment"># 修改表属性</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hive_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample_alert2 <span class="token keyword">SET</span> TBLPROPERTIES <span class="token punctuation">(</span>
    <span class="token string">'read.split.target-size'</span><span class="token operator">=</span><span class="token string">'268435456'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># 添加表描述</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hive_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample_alert2 <span class="token keyword">SET</span> TBLPROPERTIES <span class="token punctuation">(</span>
    <span class="token string">'comment'</span> <span class="token operator">=</span> <span class="token string">'A table comment.'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="删除表属性"><a href="#删除表属性" class="header-anchor">#</a> 删除表属性</h4> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hive_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample_alert2 UNSET TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'read.split.target-size'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="添加列"><a href="#添加列" class="header-anchor">#</a> 添加列</h4> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hive_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample_alert2
<span class="token keyword">ADD</span> <span class="token keyword">COLUMNS</span> <span class="token punctuation">(</span>
    category string <span class="token keyword">comment</span> <span class="token string">'new_column'</span>
  <span class="token punctuation">)</span>

<span class="token comment">-- 添加struct类型的列</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hive_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample_alert2
<span class="token keyword">ADD</span> <span class="token keyword">COLUMN</span> <span class="token keyword">point</span> struct<span class="token operator">&lt;</span>x: <span class="token keyword">double</span><span class="token punctuation">,</span> y: <span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token comment">-- 往struct类型的列中添加字段</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hive_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample_alert2
<span class="token keyword">ADD</span> <span class="token keyword">COLUMN</span> <span class="token keyword">point</span><span class="token punctuation">.</span>z <span class="token keyword">double</span>

<span class="token comment">-- 创建struct的嵌套数组列</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hive_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample_alert2
<span class="token keyword">ADD</span> <span class="token keyword">COLUMN</span> points array<span class="token operator">&lt;</span>struct<span class="token operator">&lt;</span>x: <span class="token keyword">double</span><span class="token punctuation">,</span> y: <span class="token keyword">double</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">;</span>

<span class="token comment">-- 在数组中的结构中添加一个字段。使用关键字'element'访问数组的元素列。</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hive_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample_alert2
<span class="token keyword">ADD</span> <span class="token keyword">COLUMN</span> points<span class="token punctuation">.</span>element<span class="token punctuation">.</span>z <span class="token keyword">double</span>

<span class="token comment">-- 创建一个包含Map类型的列，key和value都为struct类型</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hive_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample_alert2
<span class="token keyword">ADD</span> <span class="token keyword">COLUMN</span> pointsm map<span class="token operator">&lt;</span>struct<span class="token operator">&lt;</span>x: <span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> struct<span class="token operator">&lt;</span>a: <span class="token keyword">int</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">;</span>

<span class="token comment">-- 在Map类型的value的struct中添加一个字段。</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hive_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample_alert2
<span class="token keyword">ADD</span> <span class="token keyword">COLUMN</span> pointsm<span class="token punctuation">.</span><span class="token keyword">value</span><span class="token punctuation">.</span>b <span class="token keyword">int</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>在Spark 2.4.4及以后版本中(只针对Hadoop Catalog可以这么添加)，可以通过添加FIRST或AFTER子句在任何位置添加列:</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample_alert
<span class="token keyword">ADD</span> <span class="token keyword">COLUMN</span> new_column1 <span class="token keyword">bigint</span> <span class="token keyword">AFTER</span> id

<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample_alert
<span class="token keyword">ADD</span> <span class="token keyword">COLUMN</span> new_column2 <span class="token keyword">bigint</span> <span class="token keyword">FIRST</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="修改列"><a href="#修改列" class="header-anchor">#</a> 修改列</h4> <h5 id="修改列名"><a href="#修改列名" class="header-anchor">#</a> <strong>修改列名</strong></h5> <p>修改列名后，根据新的列名就可以查询到数据</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample_alert <span class="token keyword">RENAME</span> <span class="token keyword">COLUMN</span> <span class="token keyword">data</span> <span class="token keyword">TO</span> data1<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="alter-column修改类型-只允许安全的转换"><a href="#alter-column修改类型-只允许安全的转换" class="header-anchor">#</a> Alter Column修改类型（只允许安全的转换）</h5> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample_alert
<span class="token keyword">ADD</span> <span class="token keyword">COLUMNS</span> <span class="token punctuation">(</span>
    idd <span class="token keyword">int</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample_alert <span class="token keyword">ALTER</span> <span class="token keyword">COLUMN</span> idd <span class="token keyword">TYPE</span> <span class="token keyword">bigint</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h5 id="alter-column-修改列的注释"><a href="#alter-column-修改列的注释" class="header-anchor">#</a> Alter Column 修改列的注释</h5> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample_alert <span class="token keyword">ALTER</span> <span class="token keyword">COLUMN</span> ee <span class="token keyword">COMMENT</span> <span class="token string">'a'</span><span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample_alert <span class="token keyword">ALTER</span> <span class="token keyword">COLUMN</span> id <span class="token keyword">COMMENT</span> <span class="token string">'b'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h5 id="alter-column修改列的顺序"><a href="#alter-column修改列的顺序" class="header-anchor">#</a> Alter Column修改列的顺序</h5> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample_alert <span class="token keyword">ALTER</span> <span class="token keyword">COLUMN</span> id <span class="token keyword">FIRST</span><span class="token punctuation">;</span>

<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample_alert <span class="token keyword">ALTER</span> <span class="token keyword">COLUMN</span> new_column2 <span class="token keyword">AFTER</span> new_column1<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h5 id="alter-column修改列是否允许为null"><a href="#alter-column修改列是否允许为null" class="header-anchor">#</a> Alter Column修改列是否允许为null</h5> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample_alert <span class="token keyword">ALTER</span> <span class="token keyword">COLUMN</span> id <span class="token keyword">DROP</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>ALTER COLUMN不用于更新struct类型。使用ADD COLUMN和DROP COLUMN添加或删除struct类型的字段。</p> <h4 id="删除列"><a href="#删除列" class="header-anchor">#</a> 删除列</h4> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample_alert <span class="token keyword">DROP</span> <span class="token keyword">COLUMN</span> idd<span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample_alert <span class="token keyword">DROP</span> <span class="token keyword">COLUMN</span> <span class="token keyword">point</span><span class="token punctuation">.</span>y<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="添加分区-spark3-需要在配置文件中扩展"><a href="#添加分区-spark3-需要在配置文件中扩展" class="header-anchor">#</a> 添加分区（spark3,需要在配置文件中扩展）</h4> <p>添加配置文件</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">spark.sql.extensions</span> <span class="token punctuation">=</span> <span class="token value attr-value">org.apache.iceberg.spark.extensions.IcebergSparkSessionExtensions</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample1 <span class="token punctuation">(</span>
    id <span class="token keyword">bigint</span> <span class="token keyword">COMMENT</span> <span class="token string">'unique id'</span><span class="token punctuation">,</span>
    category string<span class="token punctuation">,</span>
    ts <span class="token keyword">timestamp</span><span class="token punctuation">,</span>
    <span class="token keyword">data</span> string<span class="token punctuation">)</span>
<span class="token keyword">USING</span> iceberg<span class="token punctuation">;</span>

<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample1 <span class="token keyword">ADD</span> <span class="token keyword">PARTITION</span> FIELD category<span class="token punctuation">;</span>

<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample1 <span class="token keyword">ADD</span> <span class="token keyword">PARTITION</span> FIELD bucket<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample1 <span class="token keyword">ADD</span> <span class="token keyword">PARTITION</span> FIELD <span class="token keyword">truncate</span><span class="token punctuation">(</span><span class="token keyword">data</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample1 <span class="token keyword">ADD</span> <span class="token keyword">PARTITION</span> FIELD years<span class="token punctuation">(</span>ts<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample1 <span class="token keyword">ADD</span> <span class="token keyword">PARTITION</span> FIELD bucket<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> category<span class="token punctuation">)</span> <span class="token keyword">AS</span> shard<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>验证一下修改分区数据存储的目录</p> <p>1.创建表无分区时添加数据</p> <p><code>insert into hadoop_prod.default.sample1 values(1,'1',null,'1');</code></p> <p><img src="https://s2.loli.net/2023/04/24/CaluQOUniyHcBSp.png" alt="image-20230414223040079"></p> <p>2.添加分区字段<code>category</code>后添加数据</p> <p><code>insert into hadoop_prod.default.sample1 values(1,'1',null,'1');</code></p> <p>发现新创建了一个目录目录下有数据文件，之前的文件也还在，分析：之前的数据不受影响，新数据会按照最新的配置进行</p> <p><img src="https://s2.loli.net/2023/04/24/gkC8yAmlUsXezb1.png" alt="image-20230414224137364"></p> <p>查询时刚刚写入的两条数据也都有</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>spark<span class="token operator">-</span><span class="token keyword">sql</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span>  hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample1<span class="token punctuation">;</span>
<span class="token number">1</span>       <span class="token number">1</span>       <span class="token boolean">NULL</span>    <span class="token number">1</span>
<span class="token number">1</span>       <span class="token number">1</span>       <span class="token boolean">NULL</span>    <span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>3.添加分区<code>bucket(16, id)</code>后添加数据</p> <p><code>insert into hadoop_prod.default.sample1 values(1,'1',null,'1');</code></p> <p>发现和刚刚一样，新数据按照新的分区规则写入，老的数据还是不变，后面就不一一测试了，我们可以确认刚刚分析的结论：<strong>之前的数据不受影响，新数据会按照最新的配置进行</strong></p> <p><img src="https://s2.loli.net/2023/04/24/zv8wIcJAlKOxUuX.png" alt="image-20230414224423710"></p> <h4 id="删除分区-spark3-需要配置扩展"><a href="#删除分区-spark3-需要配置扩展" class="header-anchor">#</a> 删除分区（Spark3，需要配置扩展）</h4> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample1 <span class="token keyword">DROP</span> <span class="token keyword">PARTITION</span> FIELD category<span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample1 <span class="token keyword">DROP</span> <span class="token keyword">PARTITION</span> FIELD bucket<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample1 <span class="token keyword">DROP</span> <span class="token keyword">PARTITION</span> FIELD <span class="token keyword">truncate</span><span class="token punctuation">(</span><span class="token keyword">data</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample1 <span class="token keyword">DROP</span> <span class="token keyword">PARTITION</span> FIELD years<span class="token punctuation">(</span>ts<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample1 <span class="token keyword">DROP</span> <span class="token keyword">PARTITION</span> FIELD shard<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>注意，尽管删除了分区，但列仍然存在于表结构中。</p> <p>删除分区字段是元数据操作，不会改变任何现有的表数据。新数据将被写入新的分区，但现有数据将保留在旧的分区布局中。</p> <p>当分区发生变化时，动态分区覆盖行为也会发生变化。例如，如果按天划分分区，而改为按小时划分分区，那么覆盖将覆盖每小时划分的分区，而不再覆盖按天划分的分区。</p> <p>删除分区字段时要小心，可能导致元数据查询失败或产生不同的结果。</p> <h4 id="修改分区-spark3-需要配置扩展"><a href="#修改分区-spark3-需要配置扩展" class="header-anchor">#</a> 修改分区（Spark3，需要配置扩展）</h4> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample1 <span class="token keyword">REPLACE</span> <span class="token keyword">PARTITION</span> FIELD bucket<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span> <span class="token keyword">WITH</span> bucket<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="修改表的写入顺序"><a href="#修改表的写入顺序" class="header-anchor">#</a> 修改表的写入顺序</h4> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample1 <span class="token keyword">WRITE</span> ORDERED <span class="token keyword">BY</span> category<span class="token punctuation">,</span> id

<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample1 <span class="token keyword">WRITE</span> ORDERED <span class="token keyword">BY</span> category <span class="token keyword">ASC</span><span class="token punctuation">,</span> id <span class="token keyword">DESC</span>

<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample1 <span class="token keyword">WRITE</span> ORDERED <span class="token keyword">BY</span> category <span class="token keyword">ASC</span> NULLS <span class="token keyword">LAST</span><span class="token punctuation">,</span> id <span class="token keyword">DESC</span> NULLS <span class="token keyword">FIRST</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>表写顺序不能保证查询的数据顺序。它只影响数据写入表的方式。</p> <p>WRITE ORDERED BY设置了一个全局排序，即跨任务的行排序，就像在INSERT命令中使用ORDER BY一样:</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample1
<span class="token keyword">SELECT</span> id<span class="token punctuation">,</span> <span class="token keyword">data</span><span class="token punctuation">,</span> category<span class="token punctuation">,</span> ts <span class="token keyword">FROM</span> another_table
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> ts<span class="token punctuation">,</span> category
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>要在每个任务内排序，而不是跨任务排序，使用local ORDERED BY:</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample1 <span class="token keyword">WRITE</span> LOCALLY ORDERED <span class="token keyword">BY</span> category<span class="token punctuation">,</span> id
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="按分区并行写入"><a href="#按分区并行写入" class="header-anchor">#</a> 按分区并行写入</h4> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample1 <span class="token keyword">WRITE</span> <span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token keyword">PARTITION</span>

<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>sample1 <span class="token keyword">WRITE</span> <span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token keyword">PARTITION</span> LOCALLY ORDERED <span class="token keyword">BY</span> category<span class="token punctuation">,</span> id
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_3-4插入数据"><a href="#_3-4插入数据" class="header-anchor">#</a> 3.4插入数据</h3> <p>测试表</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>a <span class="token punctuation">(</span>
    id <span class="token keyword">bigint</span><span class="token punctuation">,</span>
    count <span class="token keyword">bigint</span><span class="token punctuation">)</span>
<span class="token keyword">USING</span> iceberg<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>b <span class="token punctuation">(</span>
    id <span class="token keyword">bigint</span><span class="token punctuation">,</span>
count <span class="token keyword">bigint</span><span class="token punctuation">,</span>
flag string<span class="token punctuation">)</span>
<span class="token keyword">USING</span> iceberg<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="insert-into"><a href="#insert-into" class="header-anchor">#</a> INSERT INTO</h4> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>a <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>b <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="merge-into-行级更新"><a href="#merge-into-行级更新" class="header-anchor">#</a> MERGE INTO 行级更新</h4> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">MERGE</span> <span class="token keyword">INTO</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>a t 
<span class="token keyword">USING</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>b<span class="token punctuation">)</span> u <span class="token keyword">ON</span> t<span class="token punctuation">.</span>id <span class="token operator">=</span> u<span class="token punctuation">.</span>id
<span class="token keyword">WHEN</span> <span class="token keyword">MATCHED</span> <span class="token operator">AND</span> u<span class="token punctuation">.</span>flag<span class="token operator">=</span><span class="token string">'b'</span> <span class="token keyword">THEN</span> <span class="token keyword">UPDATE</span> <span class="token keyword">SET</span> t<span class="token punctuation">.</span>count <span class="token operator">=</span> t<span class="token punctuation">.</span>count <span class="token operator">+</span> u<span class="token punctuation">.</span>count
<span class="token keyword">WHEN</span> <span class="token keyword">MATCHED</span> <span class="token operator">AND</span> u<span class="token punctuation">.</span>flag<span class="token operator">=</span><span class="token string">'a'</span> <span class="token keyword">THEN</span> <span class="token keyword">DELETE</span>
<span class="token keyword">WHEN</span> <span class="token operator">NOT</span> <span class="token keyword">MATCHED</span> <span class="token keyword">THEN</span> <span class="token keyword">INSERT</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span>count<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span>u<span class="token punctuation">.</span>id<span class="token punctuation">,</span>u<span class="token punctuation">.</span>count<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>语句分析：</p> <p>表a与表b通过id字段关联，当表b的flag='b'时，修改表a的count值=表a count+表b count;</p> <p>当表b的flag='a'时，删除表a中的数据；</p> <p>当匹配不上时，新增该条数据；</p> <p>执行流程与执行结果</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>spark<span class="token operator">-</span><span class="token keyword">sql</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span>  hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>a<span class="token punctuation">;</span>
<span class="token number">1</span>       <span class="token number">1</span>
<span class="token number">2</span>       <span class="token number">2</span>
<span class="token number">3</span>       <span class="token number">3</span>
<span class="token keyword">Time</span> taken: <span class="token number">0.451</span> seconds<span class="token punctuation">,</span> Fetched <span class="token number">3</span> <span class="token keyword">row</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
spark<span class="token operator">-</span><span class="token keyword">sql</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span>  hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>b<span class="token punctuation">;</span>
<span class="token number">1</span>       <span class="token number">1</span>       a
<span class="token number">2</span>       <span class="token number">2</span>       b
<span class="token number">4</span>       <span class="token number">4</span>       d
<span class="token keyword">Time</span> taken: <span class="token number">0.542</span> seconds<span class="token punctuation">,</span> Fetched <span class="token number">3</span> <span class="token keyword">row</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
spark<span class="token operator">-</span><span class="token keyword">sql</span><span class="token operator">&gt;</span> <span class="token keyword">MERGE</span> <span class="token keyword">INTO</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>a t 
         <span class="token operator">&gt;</span> <span class="token keyword">USING</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>b<span class="token punctuation">)</span> u <span class="token keyword">ON</span> t<span class="token punctuation">.</span>id <span class="token operator">=</span> u<span class="token punctuation">.</span>id
         <span class="token operator">&gt;</span> <span class="token keyword">WHEN</span> <span class="token keyword">MATCHED</span> <span class="token operator">AND</span> u<span class="token punctuation">.</span>flag<span class="token operator">=</span><span class="token string">'b'</span> <span class="token keyword">THEN</span> <span class="token keyword">UPDATE</span> <span class="token keyword">SET</span> t<span class="token punctuation">.</span>count <span class="token operator">=</span> t<span class="token punctuation">.</span>count <span class="token operator">+</span> u<span class="token punctuation">.</span>count
         <span class="token operator">&gt;</span> <span class="token keyword">WHEN</span> <span class="token keyword">MATCHED</span> <span class="token operator">AND</span> u<span class="token punctuation">.</span>flag<span class="token operator">=</span><span class="token string">'a'</span> <span class="token keyword">THEN</span> <span class="token keyword">DELETE</span>
         <span class="token operator">&gt;</span> <span class="token keyword">WHEN</span> <span class="token operator">NOT</span> <span class="token keyword">MATCHED</span> <span class="token keyword">THEN</span> <span class="token keyword">INSERT</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span>count<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span>u<span class="token punctuation">.</span>id<span class="token punctuation">,</span>u<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">Time</span> taken: <span class="token number">4.833</span> seconds
spark<span class="token operator">-</span><span class="token keyword">sql</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span>  hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>a<span class="token punctuation">;</span>
<span class="token number">4</span>       <span class="token number">4</span>
<span class="token number">2</span>       <span class="token number">4</span>
<span class="token number">3</span>       <span class="token number">3</span>
<span class="token keyword">Time</span> taken: <span class="token number">0.281</span> seconds<span class="token punctuation">,</span> Fetched <span class="token number">3</span> <span class="token keyword">row</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="_3-5查询数据"><a href="#_3-5查询数据" class="header-anchor">#</a> 3.5查询数据</h3> <h4 id="普通查询"><a href="#普通查询" class="header-anchor">#</a> 普通查询</h4> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">as</span> count<span class="token punctuation">,</span> <span class="token keyword">data</span>
<span class="token keyword">FROM</span> <span class="token keyword">local</span><span class="token punctuation">.</span>db<span class="token punctuation">.</span><span class="token keyword">table</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">data</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="查询元数据"><a href="#查询元数据" class="header-anchor">#</a> 查询元数据</h4> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">// 查询表快照</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>a<span class="token punctuation">.</span>snapshots

<span class="token comment">// 查询数据文件信息</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>a<span class="token punctuation">.</span>files

<span class="token comment">// 查询表历史</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>a<span class="token punctuation">.</span>history

<span class="token comment">// 查询 manifest</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> hadoop_prod<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>a<span class="token punctuation">.</span>manifests
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_3-6存储过程"><a href="#_3-6存储过程" class="header-anchor">#</a> 3.6存储过程</h3> <p>Procedures可以通过CALL从任何已配置的Iceberg Catalog中使用。所有Procedures都在namespace中。</p> <h4 id="语法"><a href="#语法" class="header-anchor">#</a> 语法</h4> <p>按照参数名传参</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CALL</span> catalog_name<span class="token punctuation">.</span>system<span class="token punctuation">.</span>procedure_name<span class="token punctuation">(</span>arg_name_2 <span class="token operator">=</span><span class="token operator">&gt;</span> arg_2<span class="token punctuation">,</span> arg_name_1 <span class="token operator">=</span><span class="token operator">&gt;</span> arg_1<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>当按位置传递参数时，如果结束参数是可选的，则只有结束参数可以省略。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CALL</span> catalog_name<span class="token punctuation">.</span>system<span class="token punctuation">.</span>procedure_name<span class="token punctuation">(</span>arg_1<span class="token punctuation">,</span> arg_2<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> arg_n<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="四、dataframe操作"><a href="#四、dataframe操作" class="header-anchor">#</a> 四、DataFrame操作</h2> <h3 id="_4-1环境准备"><a href="#_4-1环境准备" class="header-anchor">#</a> 4.1环境准备</h3> <h4 id="创建maven工程-pom-xml文件内容"><a href="#创建maven工程-pom-xml文件内容" class="header-anchor">#</a> 创建Maven工程，pom.xml文件内容</h4> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scala.binary.version</span><span class="token punctuation">&gt;</span></span>2.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scala.binary.version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spark.version</span><span class="token punctuation">&gt;</span></span>3.2.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spark.version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.source</span><span class="token punctuation">&gt;</span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.source</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.target</span><span class="token punctuation">&gt;</span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.target</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- Spark的依赖引入 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spark-core_${scala.binary.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!--            &lt;scope&gt;provided&lt;/scope&gt;--&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spark.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spark-sql_${scala.binary.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!--            &lt;scope&gt;provided&lt;/scope&gt;--&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spark.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spark-hive_${scala.binary.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!--            &lt;scope&gt;provided&lt;/scope&gt;--&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spark.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token comment">&lt;!--fastjson &lt;= 1.2.80 存在安全漏洞,--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.83<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>


        <span class="token comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.iceberg/iceberg-spark-runtime-3.3 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.iceberg<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>iceberg-spark-runtime-3.2_2.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>


    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!-- assembly打包插件 --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>maven-assembly-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>make-assembly<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase</span><span class="token punctuation">&gt;</span></span>package<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phase</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>single<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>archive</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifest</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>manifest</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>archive</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>descriptorRefs</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>descriptorRef</span><span class="token punctuation">&gt;</span></span>jar-with-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>descriptorRef</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>descriptorRefs</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>

            <span class="token comment">&lt;!--Maven编译scala所需依赖--&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>net.alchim31.maven<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>scala-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.2.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>compile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>testCompile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br></div></div><h4 id="代码中配置catalog"><a href="#代码中配置catalog" class="header-anchor">#</a> 代码中配置Catalog</h4> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code> <span class="token keyword">var</span> spark<span class="token operator">:</span> SparkSession <span class="token operator">=</span> SparkSession<span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>master<span class="token punctuation">(</span><span class="token string">&quot;local&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>appName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">)</span>
      <span class="token comment">//指定hive catalog, catalog名称为iceberg_hive</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">&quot;spark.sql.catalog.iceberg_hive&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.iceberg.spark.SparkCatalog&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">&quot;spark.sql.catalog.iceberg_hive.type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hive&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">&quot;spark.sql.catalog.iceberg_hive.uri&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;thrift://172.16.24.199:9083&quot;</span><span class="token punctuation">)</span>
      <span class="token comment">//    .config(&quot;iceberg.engine.hive.enabled&quot;, &quot;true&quot;)</span>
      <span class="token comment">//指定hadoop catalog，catalog名称为iceberg_hadoop</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">&quot;spark.sql.catalog.iceberg_hadoop&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.iceberg.spark.SparkCatalog&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">&quot;spark.sql.catalog.iceberg_hadoop.type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hadoop&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">&quot;spark.sql.catalog.iceberg_hadoop.warehouse&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hdfs://172.16.24.198:8020/warehouse/spark-iceberg-code&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="_4-2读取表"><a href="#_4-2读取表" class="header-anchor">#</a> 4.2读取表</h3> <h4 id="加载表"><a href="#加载表" class="header-anchor">#</a> 加载表</h4> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code> <span class="token comment">/**
   * 使用 Spark SQL 的方式展示指定表格的数据
   *
   * @param hadoopCatalogAndNamespace Hadoop Catalog 和 namespace，格式为 &quot;catalog.namespace&quot;
   * @param tableName                 表格名称
   */</span>
  <span class="token keyword">def</span> showTableData1<span class="token punctuation">(</span>hadoopCatalogAndNamespace<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> tableName<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 切换到指定的 namespace</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;use &quot;</span> <span class="token operator">+</span> hadoopCatalogAndNamespace<span class="token punctuation">)</span>
    <span class="token comment">// 获取指定表格的全部数据</span>
    spark<span class="token punctuation">.</span>table<span class="token punctuation">(</span>tableName<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 使用 Spark SQL 的方式展示指定表格的数据
   *
   * @param hadoopCatalogAndNamespace Hadoop Catalog 和 namespace，格式为 &quot;catalog.namespace&quot;
   * @param tableName                 表格名称
   */</span>
  <span class="token keyword">def</span> showTableData2<span class="token punctuation">(</span>hadoopCatalogAndNamespace<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> tableName<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 切换到指定的 namespace</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;use &quot;</span> <span class="token operator">+</span> hadoopCatalogAndNamespace<span class="token punctuation">)</span>
    <span class="token comment">// 获取指定表格的全部数据</span>
    spark<span class="token punctuation">.</span>table<span class="token punctuation">(</span>tableName<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 使用 Iceberg 的方式展示指定表格的数据
   *
   * @param hadoopNamespace Hadoop 的 namespace
   * @param tableName       表格名称
   */</span>
  <span class="token keyword">def</span> showTableData3<span class="token punctuation">(</span>hadoopNamespace<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> tableName<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 拼接表格在 HDFS 上的路径</span>
    <span class="token keyword">val</span> tableHDFS <span class="token operator">=</span> <span class="token string">&quot;hdfs://172.16.24.198:8020/warehouse/spark-iceberg-code/&quot;</span> <span class="token operator">+</span> hadoopNamespace <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> tableName
    <span class="token comment">// 通过 Iceberg 的方式获取指定表格的全部数据</span>
    spark<span class="token punctuation">.</span>read
      <span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">&quot;iceberg&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>load<span class="token punctuation">(</span>tableHDFS<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><h4 id="时间旅行-查询指定时间戳之前的数据"><a href="#时间旅行-查询指定时间戳之前的数据" class="header-anchor">#</a> 时间旅行：查询指定时间戳之前的数据</h4> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code>  <span class="token comment">/**
   * 查询指定时间戳之前的数据
   *
   * @param hadoopNamespace Hadoop 的 namespace
   * @param tableName       表格名称
   * @return DataFrame 对象
   */</span>
  <span class="token keyword">def</span> queryDataBeforeTimestamp<span class="token punctuation">(</span>hadoopNamespace<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> tableName<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 拼接表格在 HDFS 上的路径</span>
    <span class="token keyword">val</span> tableHDFS <span class="token operator">=</span> <span class="token string">&quot;hdfs://172.16.24.198:8020/warehouse/spark-iceberg-code/&quot;</span> <span class="token operator">+</span> hadoopNamespace <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> tableName
    <span class="token comment">// 使用 Iceberg 的方式获取指定时间戳之前的数据</span>
    spark<span class="token punctuation">.</span>read
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;as-of-timestamp&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1681804793000&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">&quot;iceberg&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>load<span class="token punctuation">(</span>tableHDFS<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="时间旅行-查询指定快照-id-的数据"><a href="#时间旅行-查询指定快照-id-的数据" class="header-anchor">#</a> 时间旅行：查询指定快照 ID 的数据</h4> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code>  <span class="token comment">/**
   * 查询指定快照 ID 的数据
   *
   * @param hadoopNamespace Hadoop 的名称空间
   * @param tableName       表的名称
   * @return DataFrame 对象
   */</span>
  <span class="token keyword">def</span> querySnapshotData<span class="token punctuation">(</span>hadoopNamespace<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> tableName<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 构建表在 HDFS 上的路径</span>
    <span class="token keyword">val</span> tableHDFS <span class="token operator">=</span> <span class="token string">&quot;hdfs://172.16.24.198:8020/warehouse/spark-iceberg-code/&quot;</span> <span class="token operator">+</span> hadoopNamespace <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> tableName
    <span class="token comment">// 使用 Iceberg 的格式加载指定快照 ID 的数据，并返回 DataFrame 对象</span>
    spark<span class="token punctuation">.</span>read
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;snapshot-id&quot;</span><span class="token punctuation">,</span> <span class="token number">1150221491570194004L</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">&quot;iceberg&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>load<span class="token punctuation">(</span>tableHDFS<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="读取指定两个快照-id-之间增量数据"><a href="#读取指定两个快照-id-之间增量数据" class="header-anchor">#</a> 读取指定两个快照 ID 之间增量数据</h4> <blockquote><p>查询的表只能是append的方式写数据，不支持replace, overwrite, delete操作。</p></blockquote> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token comment">/**
   * 读取指定两个快照 ID 之间增量数据并返回 DataFrame 对象
   *
   * @param hadoopNamespace Hadoop 的名称空间
   * @param tableName       表的名称
   * @return DataFrame 对象
   */</span>
  <span class="token keyword">def</span> getTwoSnapshotsIncrementalData<span class="token punctuation">(</span>hadoopNamespace<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> tableName<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> DataFrame <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 构建表在 HDFS 上的路径</span>
    <span class="token keyword">val</span> tableHDFS <span class="token operator">=</span> <span class="token string-interpolation"><span class="token id function">s</span><span class="token string">&quot;hdfs://172.16.24.198:8020/warehouse/spark-iceberg-code/</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">hadoopNamespace</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">tableName</span></span><span class="token string">&quot;</span></span>
    <span class="token comment">// 使用 Iceberg 的格式加载指定两个快照 ID 之间的增量数据，并返回 DataFrame 对象</span>
    spark<span class="token punctuation">.</span>read
      <span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">&quot;iceberg&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;start-snapshot-id&quot;</span><span class="token punctuation">,</span> <span class="token number">4809403494114685238L</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;end-snapshot-id&quot;</span><span class="token punctuation">,</span> <span class="token number">1150221491570194004L</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>load<span class="token punctuation">(</span>tableHDFS<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="_4-3检查表"><a href="#_4-3检查表" class="header-anchor">#</a> 4.3检查表</h3> <h4 id="查询表元数据"><a href="#查询表元数据" class="header-anchor">#</a> 查询表元数据</h4> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code> <span class="token comment">/**
   * 加载指定快照 ID 下的 Iceberg 表元数据并返回 DataFrame
   *
   * @return DataFrame 对象
   */</span>
  <span class="token keyword">def</span> loadSnapshotDataFiles<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    spark<span class="token punctuation">.</span>read<span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">&quot;iceberg&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;snapshot-id&quot;</span><span class="token punctuation">,</span> <span class="token number">4809403494114685238L</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">&quot;iceberg_hadoop.default.sample1.files&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 加载指定 Iceberg 表的元数据并返回 DataFrame
   *
   * @return DataFrame 对象
   */</span>
  <span class="token keyword">def</span> loadIcebergTableFiles<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    spark<span class="token punctuation">.</span>read<span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">&quot;iceberg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">&quot;hdfs://172.16.24.198:8020/warehouse/spark-iceberg-code/default/sample1#files&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h4 id="指定快照id查询元数据"><a href="#指定快照id查询元数据" class="header-anchor">#</a> 指定快照ID查询元数据</h4> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code> <span class="token comment">/**
   * 加载指定快照 ID 下的 Iceberg 表元数据并返回 DataFrame
   *
   * @return DataFrame 对象
   */</span>
  <span class="token keyword">def</span> loadSnapshotDataFiles<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    spark<span class="token punctuation">.</span>read<span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">&quot;iceberg&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;snapshot-id&quot;</span><span class="token punctuation">,</span> <span class="token number">4809403494114685238L</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">&quot;iceberg_hadoop.default.sample1.files&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="_4-4写入表"><a href="#_4-4写入表" class="header-anchor">#</a> 4.4写入表</h3> <h4 id="创建替换表结构并写入数据"><a href="#创建替换表结构并写入数据" class="header-anchor">#</a> 创建替换表结构并写入数据</h4> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token comment">// 创建或替换表</span>
<span class="token keyword">def</span> createOrReplaceTable<span class="token punctuation">(</span>tableName<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">val</span> spark <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>spark <span class="token comment">// 获取 SparkSession 对象</span>
  <span class="token comment">// 创建包含数据的 DataFrame 对象。</span>
  <span class="token keyword">val</span> dataFrame<span class="token operator">:</span> DataFrame <span class="token operator">=</span> spark<span class="token punctuation">.</span>createDataFrame<span class="token punctuation">(</span>
    Seq<span class="token punctuation">(</span>Sample1<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">new</span> Date<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLocaleString<span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      Sample1<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">new</span> Date<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLocaleString<span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      Sample1<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token keyword">new</span> Date<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLocaleString<span class="token punctuation">,</span> <span class="token string">&quot;c&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">import</span> <span class="token namespace">spark<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span></span>_
  dataFrame<span class="token punctuation">.</span>writeTo<span class="token punctuation">(</span>tableName<span class="token punctuation">)</span> <span class="token comment">// 写入表</span>
    <span class="token punctuation">.</span>tableProperty<span class="token punctuation">(</span><span class="token string">&quot;write.format.default&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;orc&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 表设置</span>
    <span class="token comment">//$ 符号是 Scala 语言中用于将对象转换为列的操作符，例如 $&quot;category&quot; 就表示将字符串 &quot;category&quot; 转换为 DataFrame 中的列</span>
    <span class="token punctuation">.</span>partitionedBy<span class="token punctuation">(</span>$<span class="token string">&quot;category&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 分区</span>
    <span class="token punctuation">.</span>createOrReplace<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 创建或替换表</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h4 id="append添加数据"><a href="#append添加数据" class="header-anchor">#</a> append添加数据</h4> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token comment">/**
   * 向指定的 Iceberg 表追加 Sample1 类型的数据。
   *
   * @param tableName 要追加数据的表名称。
   */</span>
  <span class="token keyword">def</span> appendData<span class="token punctuation">(</span>tableName<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;select count(1) from &quot;</span> <span class="token operator">+</span> tableName<span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 创建包含数据的 DataFrame 对象。</span>
    <span class="token keyword">val</span> dataFrame<span class="token operator">:</span> DataFrame <span class="token operator">=</span> spark<span class="token punctuation">.</span>createDataFrame<span class="token punctuation">(</span>
      Seq<span class="token punctuation">(</span>Sample1<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">new</span> Date<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLocaleString<span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Sample1<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">new</span> Date<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLocaleString<span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Sample1<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token keyword">new</span> Date<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLocaleString<span class="token punctuation">,</span> <span class="token string">&quot;c&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 将 DataFrame 持久化到指定表，并调用 append() 方法将数据追加到指定表中。</span>
    dataFrame<span class="token punctuation">.</span>writeTo<span class="token punctuation">(</span>tableName<span class="token punctuation">)</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">)</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;select count(1) from &quot;</span> <span class="token operator">+</span> tableName<span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="动态分区覆盖"><a href="#动态分区覆盖" class="header-anchor">#</a> 动态分区覆盖</h4> <p>写入的数据，根据分区字段，自动覆盖写入，数据不存在的分区就不覆盖了</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code>	<span class="token comment">// 覆盖指定表的分区数据</span>
  <span class="token keyword">def</span> overwritePartitionsData<span class="token punctuation">(</span>tableName<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 使用 SQL 查询统计表的记录数并在控制台输出结果</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;select count(1) from &quot;</span> <span class="token operator">+</span> tableName<span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 创建包含数据的 DataFrame 对象。</span>
    <span class="token keyword">val</span> dataFrame<span class="token operator">:</span> DataFrame <span class="token operator">=</span> spark<span class="token punctuation">.</span>createDataFrame<span class="token punctuation">(</span>
      Seq<span class="token punctuation">(</span>Sample1<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">new</span> Date<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLocaleString<span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Sample1<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">new</span> Date<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLocaleString<span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 将 DataFrame 持久化到指定表，并调用 append() 方法将数据追加到指定表中。</span>
    dataFrame<span class="token punctuation">.</span>writeTo<span class="token punctuation">(</span>tableName<span class="token punctuation">)</span><span class="token punctuation">.</span>overwritePartitions<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 使用 SQL 查询统计表的记录数并在控制台输出结果</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;select count(1) from &quot;</span> <span class="token operator">+</span> tableName<span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="静态分区覆盖"><a href="#静态分区覆盖" class="header-anchor">#</a> 静态分区覆盖</h4> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code> <span class="token comment">// 覆盖指定表的指定分区数据，其他分区直接追加</span>
  def overwritePartitionsData2<span class="token punctuation">(</span>tableName: String<span class="token punctuation">)</span> <span class="token operator">=</span> {
    <span class="token comment">// 获取 SparkSession 对象并为其创建一个变量 spark。</span>
    val spark: SparkSession <span class="token operator">=</span> this<span class="token punctuation">.</span>spark
    <span class="token comment">// 使用 SQL 查询统计表的记录数并在控制台输出结果。</span>
    spark<span class="token punctuation">.</span><span class="token keyword">sql</span><span class="token punctuation">(</span><span class="token string">&quot;select count(1) from &quot;</span> <span class="token operator">+</span> tableName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">import</span> spark<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span>_
    val dataFrame: DataFrame <span class="token operator">=</span> spark<span class="token punctuation">.</span>createDataFrame<span class="token punctuation">(</span>
      Seq<span class="token punctuation">(</span>Sample1<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> new <span class="token keyword">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLocaleString<span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Sample1<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> new <span class="token keyword">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLocaleString<span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 将指定 DataFrame 对象的数据覆盖到 tableName 表中，其中仅覆盖 category 字段等于 a 的分区。</span>
    dataFrame<span class="token punctuation">.</span>writeTo<span class="token punctuation">(</span>tableName<span class="token punctuation">)</span><span class="token punctuation">.</span>overwrite<span class="token punctuation">(</span>$<span class="token string">&quot;category&quot;</span> <span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">// 使用 SQL 查询统计表的记录数并在控制台输出结果。</span>
    spark<span class="token punctuation">.</span><span class="token keyword">sql</span><span class="token punctuation">(</span><span class="token string">&quot;select count(1) from &quot;</span> <span class="token operator">+</span> tableName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="_4-5维护表"><a href="#_4-5维护表" class="header-anchor">#</a> 4.5维护表</h3> <h4 id="获取table对象"><a href="#获取table对象" class="header-anchor">#</a> 获取Table对象</h4> <ul><li>HadoopCatalog</li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>conf<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>iceberg<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span></span><span class="token class-name">HadoopCatalog</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>iceberg<span class="token punctuation">.</span></span><span class="token class-name">Table</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>iceberg<span class="token punctuation">.</span>catalog<span class="token punctuation">.</span></span><span class="token class-name">TableIdentifier</span></span><span class="token punctuation">;</span>

<span class="token keyword">val</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> Configuration<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> catalog <span class="token operator">=</span> <span class="token keyword">new</span> HadoopCatalog<span class="token punctuation">(</span>conf<span class="token punctuation">,</span><span class="token string">&quot;hdfs://hadoop1:8020/warehouse/spark-iceberg&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> table<span class="token operator">:</span> Table <span class="token operator">=</span> catalog<span class="token punctuation">.</span>loadTable<span class="token punctuation">(</span>TableIdentifier<span class="token punctuation">.</span>of<span class="token punctuation">(</span><span class="token string">&quot;db&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;table1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>HiveCatalog</li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>iceberg<span class="token punctuation">.</span>hive<span class="token punctuation">.</span></span><span class="token class-name">HiveCatalog</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>iceberg<span class="token punctuation">.</span></span><span class="token class-name">Table</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>iceberg<span class="token punctuation">.</span>catalog<span class="token punctuation">.</span></span><span class="token class-name">TableIdentifier</span></span><span class="token punctuation">;</span>

<span class="token keyword">val</span> catalog <span class="token operator">=</span> <span class="token keyword">new</span> HiveCatalog<span class="token punctuation">(</span><span class="token punctuation">)</span>
catalog<span class="token punctuation">.</span>setConf<span class="token punctuation">(</span>spark<span class="token punctuation">.</span>sparkContext<span class="token punctuation">.</span>hadoopConfiguration<span class="token punctuation">)</span>

<span class="token keyword">val</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> util<span class="token punctuation">.</span>HashMap<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
properties<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">&quot;warehouse&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hdfs://hadoop1:8020/warehouse/spark-iceberg&quot;</span><span class="token punctuation">)</span>
properties<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">&quot;uri&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;thrift://hadoop1:9083&quot;</span><span class="token punctuation">)</span>

catalog<span class="token punctuation">.</span>initialize<span class="token punctuation">(</span><span class="token string">&quot;hive&quot;</span><span class="token punctuation">,</span> properties<span class="token punctuation">)</span>
<span class="token keyword">val</span> table<span class="token operator">:</span> Table <span class="token operator">=</span> catalog<span class="token punctuation">.</span>loadTable<span class="token punctuation">(</span>TableIdentifier<span class="token punctuation">.</span>of<span class="token punctuation">(</span><span class="token string">&quot;db&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;table1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="快照过期清理"><a href="#快照过期清理" class="header-anchor">#</a> 快照过期清理</h4> <p>每次写入Iceberg表都会创建一个表的新快照或版本。快照可以用于时间旅行查询，或者可以将表回滚到任何有效的快照。建议设置快照过期时间，过期的旧快照将从元数据中删除（不再可用于时间旅行查询）。</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token comment">/**
   * 对样例表进行快照过期清理
   */</span>
  <span class="token keyword">def</span> snapshotOverdueClean<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建 Hadoop Configuration 对象</span>
    <span class="token keyword">val</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> Configuration<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 基于 Hadoop Catalog API 加载表格</span>
    <span class="token keyword">val</span> catalog <span class="token operator">=</span> <span class="token keyword">new</span> HadoopCatalog<span class="token punctuation">(</span>conf<span class="token punctuation">,</span> <span class="token string">&quot;hdfs://172.16.24.198:8020/warehouse/spark-iceberg-code&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> table<span class="token operator">:</span> Table <span class="token operator">=</span> catalog<span class="token punctuation">.</span>loadTable<span class="token punctuation">(</span>TableIdentifier<span class="token punctuation">.</span>of<span class="token punctuation">(</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sample1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 设置过期时间（这里设置7天前的时间）</span>
    <span class="token keyword">val</span> tsToExpire<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> System<span class="token punctuation">.</span>currentTimeMillis<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">)</span>
    <span class="token comment">// 过期快照并提交更改</span>
    table<span class="token punctuation">.</span>expireSnapshots<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>expireOlderThan<span class="token punctuation">(</span>tsToExpire<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>或使用SparkActions来设置过期：</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code> <span class="token comment">/**
   * 对样例表进行快照过期清理2
   */</span>
  <span class="token keyword">def</span> snapshotOverdueClean2<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建 Hadoop Configuration 对象</span>
    <span class="token keyword">val</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> Configuration<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 基于 Hadoop Catalog API 加载表格</span>
    <span class="token keyword">val</span> catalog <span class="token operator">=</span> <span class="token keyword">new</span> HadoopCatalog<span class="token punctuation">(</span>conf<span class="token punctuation">,</span> <span class="token string">&quot;hdfs://172.16.24.198:8020/warehouse/spark-iceberg-code&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> table<span class="token operator">:</span> Table <span class="token operator">=</span> catalog<span class="token punctuation">.</span>loadTable<span class="token punctuation">(</span>TableIdentifier<span class="token punctuation">.</span>of<span class="token punctuation">(</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sample1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 设置过期时间（这里设置7天前的时间）</span>
    <span class="token keyword">val</span> tsToExpire<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> System<span class="token punctuation">.</span>currentTimeMillis<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">)</span>
    SparkActions<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>expireSnapshots<span class="token punctuation">(</span>table<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>expireOlderThan<span class="token punctuation">(</span>tsToExpire<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="删除无效文件"><a href="#删除无效文件" class="header-anchor">#</a> 删除无效文件</h4> <p>在Spark和其他分布式处理引擎中，任务或作业失败可能会留下未被表元数据引用的文件，在某些情况下，正常的快照过期可能无法确定不再需要并删除该文件。</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token comment">/**
   * 删除无效文件
   */</span>
  <span class="token keyword">def</span> deleteInvalidFile<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建 Hadoop Configuration 对象</span>
    <span class="token keyword">val</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> Configuration<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 基于 Hadoop Catalog API 加载表格</span>
    <span class="token keyword">val</span> catalog <span class="token operator">=</span> <span class="token keyword">new</span> HadoopCatalog<span class="token punctuation">(</span>conf<span class="token punctuation">,</span> <span class="token string">&quot;hdfs://172.16.24.198:8020/warehouse/spark-iceberg-code&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> table<span class="token operator">:</span> Table <span class="token operator">=</span> catalog<span class="token punctuation">.</span>loadTable<span class="token punctuation">(</span>TableIdentifier<span class="token punctuation">.</span>of<span class="token punctuation">(</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sample1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    SparkActions
      <span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>deleteOrphanFiles<span class="token punctuation">(</span>table<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="合并小文件"><a href="#合并小文件" class="header-anchor">#</a> 合并小文件</h4> <p>数据文件过多会导致更多的元数据存储在清单文件中，而较小的数据文件会导致不必要的元数据量和更低效率的文件打开成本。</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code>
  <span class="token comment">/**
   * 合并小文件
   */</span>
  <span class="token keyword">def</span> mergeSmallFiles<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> Configuration<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> catalog <span class="token operator">=</span> <span class="token keyword">new</span> HadoopCatalog<span class="token punctuation">(</span>conf<span class="token punctuation">,</span> <span class="token string">&quot;hdfs://172.16.24.198:8020/warehouse/spark-iceberg-code&quot;</span><span class="token punctuation">)</span>

    <span class="token comment">// 加载表对象</span>
    <span class="token keyword">val</span> table<span class="token operator">:</span> Table <span class="token operator">=</span> catalog<span class="token punctuation">.</span>loadTable<span class="token punctuation">(</span>TableIdentifier<span class="token punctuation">.</span>of<span class="token punctuation">(</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sample1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    SparkActions
      <span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//使用SparkActions获取操作对象实例</span>
      <span class="token punctuation">.</span>rewriteDataFiles<span class="token punctuation">(</span>table<span class="token punctuation">)</span> <span class="token comment">//将表中的数据重写成查询引擎可读的格式</span>
      <span class="token punctuation">.</span>filter<span class="token punctuation">(</span>Expressions<span class="token punctuation">.</span>equal<span class="token punctuation">(</span><span class="token string">&quot;category&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//使用Iceberg表达式引擎过滤category列等于a的记录</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;target-file-size-bytes&quot;</span><span class="token punctuation">,</span> <span class="token number">1024L</span><span class="token punctuation">.</span>toString<span class="token punctuation">)</span> <span class="token comment">//设置目标文件大小为1KB</span>
      <span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//执行合并小文件操作并生成新版本</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h2 id="五、整体代码"><a href="#五、整体代码" class="header-anchor">#</a> 五、整体代码</h2> <h3 id="代码"><a href="#代码" class="header-anchor">#</a> 代码</h3> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">wiki<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>iceberg<span class="token punctuation">.</span>spark</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Date

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>conf<span class="token punctuation">.</span></span>Configuration
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>iceberg<span class="token punctuation">.</span></span>Table
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>iceberg<span class="token punctuation">.</span>catalog<span class="token punctuation">.</span></span><span class="token punctuation">{</span>Namespace<span class="token punctuation">,</span> TableIdentifier<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>iceberg<span class="token punctuation">.</span>expressions<span class="token punctuation">.</span></span>Expressions
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>iceberg<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span></span>HadoopCatalog
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>iceberg<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>actions<span class="token punctuation">.</span></span>SparkActions
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataFrame<span class="token punctuation">,</span> SparkSession<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">wiki<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>iceberg<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>Example<span class="token punctuation">.</span>Sample1

<span class="token comment">/** *
 *
 * @date 2023/4/19 下午3:51
 * @description
 * 1. descTableDesc(tableName: String): 显示指定表的元数据信息。
 * 2. createOrReplaceTable(tableName: String): 创建表，如果表存在则直接Replace表结构。
 * 3. appendData(tableName: String): 向指定的 Iceberg 表追加 Sample1 类型的数据。
 * 4. tableOrNameSpaceExists(): 判断表和数据库是否存在。
 * 5. loadSnapshotDataFiles(): 加载指定快照 ID 下的 Iceberg 表元数据并返回 DataFrame。
 * 6. loadIcebergTableFiles(fullTableName: String): 加载指定 Iceberg 表的元数据并返回 DataFrame。
 * 7. getTwoSnapshotsIncrementalData(hadoopNamespace: String, tableName: String): 读取指定两个快照 ID 之间增量数据并返回 DataFrame 对象。
 * 8. querySnapshotData(hadoopNamespace: String, tableName: String): 查询指定快照 ID 的数据。
 * 9. queryDataBeforeTimestamp(hadoopNamespace: String, tableName: String): 查询指定时间戳之前的数据。
 * 10. showTableData1(hadoopCatalogAndNamespace: String, tableName: String): 使用 Spark SQL 的方式展示指定表格的数据。
 * 11. showTableData2(hadoopCatalogAndNamespace: String, tableName: String): 使用 Spark SQL 的方式展示指定表格的数据。
 * 12. showTableData3(hadoopNamespace: String, tableName: String): 使用 Iceberg 的方式展示指定表格的数据。
 * 13. printDataFrame(dataFrame: DataFrame): 打印 DataFrame 中的数据，格式为每行数据按列名分割，行与行之间使用分隔符分割。
 * 14. showTables(): 查看指定库的所有表。
 * 15. createTable(catalogAndNamespace: String, tableName: String): 创建表。
 * 16. createDatabase(catalogAndNamespace: String): 如果不存在创建数据库。
 * @author Jast
 */</span>
<span class="token keyword">object</span> HadoopIcebergExample <span class="token punctuation">{</span>

  <span class="token comment">//指定一个特定的 Hadoop 用户运行应用程序</span>
  System<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span><span class="token string">&quot;HADOOP_USER_NAME&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hdfs&quot;</span><span class="token punctuation">)</span>

  <span class="token comment">//样例类，表结构</span>
  <span class="token keyword">case</span> <span class="token keyword">class</span> HadoopIcebergSample<span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> category<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span>

  <span class="token keyword">var</span> spark<span class="token operator">:</span> SparkSession <span class="token operator">=</span> _

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    spark <span class="token operator">=</span> SparkSession<span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>master<span class="token punctuation">(</span><span class="token string">&quot;local&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>appName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">)</span>
      <span class="token comment">//指定hive catalog, catalog名称为iceberg_hive</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">&quot;spark.sql.catalog.iceberg_hive&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.iceberg.spark.SparkCatalog&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">&quot;spark.sql.catalog.iceberg_hive.type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hive&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">&quot;spark.sql.catalog.iceberg_hive.uri&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;thrift://172.16.24.199:9083&quot;</span><span class="token punctuation">)</span>
      <span class="token comment">//    .config(&quot;iceberg.engine.hive.enabled&quot;, &quot;true&quot;)</span>
      <span class="token comment">//指定hadoop catalog，catalog名称为iceberg_hadoop</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">&quot;spark.sql.catalog.iceberg_hadoop&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.iceberg.spark.SparkCatalog&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">&quot;spark.sql.catalog.iceberg_hadoop.type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hadoop&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">&quot;spark.sql.catalog.iceberg_hadoop.warehouse&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hdfs://172.16.24.198:8020/warehouse/spark-iceberg-code&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>


    <span class="token comment">//</span>
    <span class="token keyword">val</span> hadoopCatalog <span class="token operator">=</span> <span class="token string">&quot;iceberg_hadoop&quot;</span>
    <span class="token keyword">val</span> hadoopNamespace <span class="token operator">=</span> <span class="token string">&quot;default&quot;</span>
    <span class="token keyword">val</span> hadoopCatalogAndNamespace <span class="token operator">=</span> hadoopCatalog <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> hadoopNamespace
    <span class="token keyword">val</span> tableName <span class="token operator">=</span> <span class="token string">&quot;sample1&quot;</span>
    <span class="token keyword">val</span> fullTableName <span class="token operator">=</span> hadoopCatalogAndNamespace <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> tableName

    <span class="token comment">// 创建 namespace</span>
    <span class="token comment">//        createDatabase(hadoopCatalogAndNamespace)</span>

    <span class="token comment">// 创建表</span>
    <span class="token comment">//        createTable(hadoopCatalogAndNamespace, tableName)</span>

    <span class="token comment">// 查看所有表</span>
    <span class="token comment">//    showTables()</span>

    <span class="token comment">// 查看表数据</span>
    <span class="token comment">//    printDataFrame(showTableData1(hadoopCatalogAndNamespace, tableName))</span>
    <span class="token comment">//    printDataFrame(showTableData2(hadoopCatalogAndNamespace, tableName))</span>
    <span class="token comment">//    printDataFrame(showTableData3(hadoopNamespace, tableName))</span>

    <span class="token comment">// 查询指定时间戳之前的数据</span>
    <span class="token comment">//    printDataFrame(queryDataBeforeTimestamp(hadoopNamespace, tableName))</span>

    <span class="token comment">// 查询指定快照 ID 的数据</span>
    <span class="token comment">//    printDataFrame(querySnapshotData(hadoopNamespace, tableName))</span>

    <span class="token comment">// 读取指定两个快照 ID 之间增量数据</span>
    <span class="token comment">//    printDataFrame(getTwoSnapshotsIncrementalData(hadoopNamespace, tableName))</span>

    <span class="token comment">// 加载指定 Iceberg 表的元数据</span>
    <span class="token comment">//    printDataFrame(loadIcebergTableFiles(fullTableName))</span>
    <span class="token comment">//    printDataFrame(loadIcebergTableFiles)</span>

    <span class="token comment">// 加载指定快照 ID 下的 Iceberg 表元数据</span>
    <span class="token comment">//    printDataFrame(loadSnapshotDataFiles)</span>

    <span class="token comment">// 判断表和数据库是否存在</span>
    <span class="token comment">//    tableOrNameSpaceExists()</span>

    <span class="token comment">// 显示指定表的元数据信息</span>
    <span class="token comment">//    descTableDesc(fullTableName)</span>

    <span class="token comment">// 创建表，如果表存在则直接Replace表结构</span>
    <span class="token comment">//    createOrReplaceTable(fullTableName)</span>

    <span class="token comment">// append添加数据</span>
    <span class="token comment">//    appendData(fullTableName)</span>

    <span class="token comment">//覆盖指定表的分区数据,根据分区字段动态覆盖</span>
    overwritePartitionsData<span class="token punctuation">(</span>fullTableName<span class="token punctuation">)</span>
    <span class="token comment">// 手动指定分区进行覆盖</span>
    overwritePartitionsData2<span class="token punctuation">(</span>fullTableName<span class="token punctuation">)</span>

    <span class="token comment">// 快照过期清理</span>
    <span class="token comment">//    snapshotOverdueClean</span>
    <span class="token comment">//    snapshotOverdueClean2</span>

    <span class="token comment">// 合并小文件</span>
    <span class="token comment">//    mergeSmallFiles</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 显示指定表的元数据信息。
   *
   * @param tableName 要查看元数据的表名称。
   */</span>
  <span class="token keyword">def</span> descTableDesc<span class="token punctuation">(</span>tableName<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 使用 Spark SQL 调用 desc formatted 命令来查看表的元数据信息，并使用 show() 方法显示结果。</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token id function">s</span><span class="token string">&quot;desc formatted </span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">tableName</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>


  <span class="token comment">// 创建或替换表</span>
  <span class="token keyword">def</span> createOrReplaceTable<span class="token punctuation">(</span>tableName<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> spark <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>spark <span class="token comment">// 获取 SparkSession 对象</span>
    <span class="token comment">// 创建包含数据的 DataFrame 对象。</span>
    <span class="token keyword">val</span> dataFrame<span class="token operator">:</span> DataFrame <span class="token operator">=</span> spark<span class="token punctuation">.</span>createDataFrame<span class="token punctuation">(</span>
      Seq<span class="token punctuation">(</span>Sample1<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">new</span> Date<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLocaleString<span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Sample1<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">new</span> Date<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLocaleString<span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Sample1<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token keyword">new</span> Date<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLocaleString<span class="token punctuation">,</span> <span class="token string">&quot;c&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">import</span> <span class="token namespace">spark<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span></span>_
    dataFrame<span class="token punctuation">.</span>writeTo<span class="token punctuation">(</span>tableName<span class="token punctuation">)</span> <span class="token comment">// 写入表</span>
      <span class="token punctuation">.</span>tableProperty<span class="token punctuation">(</span><span class="token string">&quot;write.format.default&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;orc&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 表设置</span>
      <span class="token comment">//$ 符号是 Scala 语言中用于将对象转换为列的操作符，例如 $&quot;category&quot; 就表示将字符串 &quot;category&quot; 转换为 DataFrame 中的列</span>
      <span class="token punctuation">.</span>partitionedBy<span class="token punctuation">(</span>$<span class="token string">&quot;category&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 分区</span>
      <span class="token punctuation">.</span>createOrReplace<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 创建或替换表</span>
  <span class="token punctuation">}</span>


  <span class="token comment">/**
   * 向指定的 Iceberg 表追加 Sample1 类型的数据。
   *
   * @param tableName 要追加数据的表名称。
   */</span>
  <span class="token keyword">def</span> appendData<span class="token punctuation">(</span>tableName<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;select count(1) from &quot;</span> <span class="token operator">+</span> tableName<span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 创建包含数据的 DataFrame 对象。</span>
    <span class="token keyword">val</span> dataFrame<span class="token operator">:</span> DataFrame <span class="token operator">=</span> spark<span class="token punctuation">.</span>createDataFrame<span class="token punctuation">(</span>
      Seq<span class="token punctuation">(</span>Sample1<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">new</span> Date<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLocaleString<span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Sample1<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">new</span> Date<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLocaleString<span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Sample1<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token keyword">new</span> Date<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLocaleString<span class="token punctuation">,</span> <span class="token string">&quot;c&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 将 DataFrame 持久化到指定表，并调用 append() 方法将数据追加到指定表中。</span>
    dataFrame<span class="token punctuation">.</span>writeTo<span class="token punctuation">(</span>tableName<span class="token punctuation">)</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">)</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;select count(1) from &quot;</span> <span class="token operator">+</span> tableName<span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 覆盖指定表的分区数据，写入的数据，根据分区字段，自动覆盖写入，数据不存在的分区就不覆盖了</span>
  <span class="token keyword">def</span> overwritePartitionsData<span class="token punctuation">(</span>tableName<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 使用 SQL 查询统计表的记录数并在控制台输出结果</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;select count(1) from &quot;</span> <span class="token operator">+</span> tableName<span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 创建包含数据的 DataFrame 对象。</span>
    <span class="token keyword">val</span> dataFrame<span class="token operator">:</span> DataFrame <span class="token operator">=</span> spark<span class="token punctuation">.</span>createDataFrame<span class="token punctuation">(</span>
      Seq<span class="token punctuation">(</span>Sample1<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token keyword">new</span> Date<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLocaleString<span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Sample1<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token keyword">new</span> Date<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLocaleString<span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 将 DataFrame 持久化到指定表，并调用 append() 方法将数据追加到指定表中。</span>
    dataFrame<span class="token punctuation">.</span>writeTo<span class="token punctuation">(</span>tableName<span class="token punctuation">)</span><span class="token punctuation">.</span>overwritePartitions<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 使用 SQL 查询统计表的记录数并在控制台输出结果</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;select count(1) from &quot;</span> <span class="token operator">+</span> tableName<span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 覆盖指定表的指定分区数据，其他分区直接追加</span>
  <span class="token keyword">def</span> overwritePartitionsData2<span class="token punctuation">(</span>tableName<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取 SparkSession 对象并为其创建一个变量 spark。</span>
    <span class="token keyword">val</span> spark<span class="token operator">:</span> SparkSession <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>spark
    <span class="token comment">// 使用 SQL 查询统计表的记录数并在控制台输出结果。</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;select count(1) from &quot;</span> <span class="token operator">+</span> tableName<span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">import</span> <span class="token namespace">spark<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span></span>_
    <span class="token keyword">val</span> dataFrame<span class="token operator">:</span> DataFrame <span class="token operator">=</span> spark<span class="token punctuation">.</span>createDataFrame<span class="token punctuation">(</span>
      Seq<span class="token punctuation">(</span>Sample1<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token keyword">new</span> Date<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLocaleString<span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Sample1<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token keyword">new</span> Date<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLocaleString<span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 将指定 DataFrame 对象的数据覆盖到 tableName 表中，其中仅覆盖 category 字段等于 a 的分区。</span>
    dataFrame<span class="token punctuation">.</span>writeTo<span class="token punctuation">(</span>tableName<span class="token punctuation">)</span><span class="token punctuation">.</span>overwrite<span class="token punctuation">(</span>$<span class="token string">&quot;category&quot;</span> <span class="token operator">==</span><span class="token operator">=</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">// 使用 SQL 查询统计表的记录数并在控制台输出结果。</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;select count(1) from &quot;</span> <span class="token operator">+</span> tableName<span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>


  <span class="token comment">/**
   * 判断表是否存在
   */</span>
  <span class="token keyword">def</span> tableOrNameSpaceExists<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> Configuration<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> catalog <span class="token operator">=</span> <span class="token keyword">new</span> HadoopCatalog<span class="token punctuation">(</span>conf<span class="token punctuation">,</span> <span class="token string">&quot;hdfs://172.16.24.198:8020/warehouse/spark-iceberg-code&quot;</span><span class="token punctuation">)</span>
    println<span class="token punctuation">(</span><span class="token string">&quot;表是否存在：&quot;</span> <span class="token operator">+</span> catalog<span class="token punctuation">.</span>tableExists<span class="token punctuation">(</span>TableIdentifier<span class="token punctuation">.</span>of<span class="token punctuation">(</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sample1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    println<span class="token punctuation">(</span><span class="token string">&quot;表是否存在：&quot;</span> <span class="token operator">+</span> catalog<span class="token punctuation">.</span>tableExists<span class="token punctuation">(</span>TableIdentifier<span class="token punctuation">.</span>of<span class="token punctuation">(</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sample2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    println<span class="token punctuation">(</span><span class="token string">&quot;数据库是否存在：&quot;</span> <span class="token operator">+</span> catalog<span class="token punctuation">.</span>namespaceExists<span class="token punctuation">(</span>Namespace<span class="token punctuation">.</span>of<span class="token punctuation">(</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    println<span class="token punctuation">(</span><span class="token string">&quot;数据库是否存在：&quot;</span> <span class="token operator">+</span> catalog<span class="token punctuation">.</span>namespaceExists<span class="token punctuation">(</span>Namespace<span class="token punctuation">.</span>of<span class="token punctuation">(</span><span class="token string">&quot;default8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 对样例表进行快照过期清理
   */</span>
  <span class="token keyword">def</span> snapshotOverdueClean<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建 Hadoop Configuration 对象</span>
    <span class="token keyword">val</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> Configuration<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 基于 Hadoop Catalog API 加载表格</span>
    <span class="token keyword">val</span> catalog <span class="token operator">=</span> <span class="token keyword">new</span> HadoopCatalog<span class="token punctuation">(</span>conf<span class="token punctuation">,</span> <span class="token string">&quot;hdfs://172.16.24.198:8020/warehouse/spark-iceberg-code&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> table<span class="token operator">:</span> Table <span class="token operator">=</span> catalog<span class="token punctuation">.</span>loadTable<span class="token punctuation">(</span>TableIdentifier<span class="token punctuation">.</span>of<span class="token punctuation">(</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sample1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 设置过期时间（这里设置7天前的时间）</span>
    <span class="token keyword">val</span> tsToExpire<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> System<span class="token punctuation">.</span>currentTimeMillis<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">)</span>
    <span class="token comment">// 过期快照并提交更改</span>
    table<span class="token punctuation">.</span>expireSnapshots<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>expireOlderThan<span class="token punctuation">(</span>tsToExpire<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 对样例表进行快照过期清理2
   */</span>
  <span class="token keyword">def</span> snapshotOverdueClean2<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建 Hadoop Configuration 对象</span>
    <span class="token keyword">val</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> Configuration<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 基于 Hadoop Catalog API 加载表格</span>
    <span class="token keyword">val</span> catalog <span class="token operator">=</span> <span class="token keyword">new</span> HadoopCatalog<span class="token punctuation">(</span>conf<span class="token punctuation">,</span> <span class="token string">&quot;hdfs://172.16.24.198:8020/warehouse/spark-iceberg-code&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> table<span class="token operator">:</span> Table <span class="token operator">=</span> catalog<span class="token punctuation">.</span>loadTable<span class="token punctuation">(</span>TableIdentifier<span class="token punctuation">.</span>of<span class="token punctuation">(</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sample1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 设置过期时间（这里设置7天前的时间）</span>
    <span class="token keyword">val</span> tsToExpire<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> System<span class="token punctuation">.</span>currentTimeMillis<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">)</span>
    SparkActions<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>expireSnapshots<span class="token punctuation">(</span>table<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>expireOlderThan<span class="token punctuation">(</span>tsToExpire<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 删除无效文件
   */</span>
  <span class="token keyword">def</span> deleteInvalidFile<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建 Hadoop Configuration 对象</span>
    <span class="token keyword">val</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> Configuration<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 基于 Hadoop Catalog API 加载表格</span>
    <span class="token keyword">val</span> catalog <span class="token operator">=</span> <span class="token keyword">new</span> HadoopCatalog<span class="token punctuation">(</span>conf<span class="token punctuation">,</span> <span class="token string">&quot;hdfs://172.16.24.198:8020/warehouse/spark-iceberg-code&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> table<span class="token operator">:</span> Table <span class="token operator">=</span> catalog<span class="token punctuation">.</span>loadTable<span class="token punctuation">(</span>TableIdentifier<span class="token punctuation">.</span>of<span class="token punctuation">(</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sample1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    SparkActions
      <span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>deleteOrphanFiles<span class="token punctuation">(</span>table<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 合并小文件
   */</span>
  <span class="token keyword">def</span> mergeSmallFiles<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> Configuration<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> catalog <span class="token operator">=</span> <span class="token keyword">new</span> HadoopCatalog<span class="token punctuation">(</span>conf<span class="token punctuation">,</span> <span class="token string">&quot;hdfs://172.16.24.198:8020/warehouse/spark-iceberg-code&quot;</span><span class="token punctuation">)</span>

    <span class="token comment">// 加载表对象</span>
    <span class="token keyword">val</span> table<span class="token operator">:</span> Table <span class="token operator">=</span> catalog<span class="token punctuation">.</span>loadTable<span class="token punctuation">(</span>TableIdentifier<span class="token punctuation">.</span>of<span class="token punctuation">(</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sample1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    SparkActions
      <span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//使用SparkActions获取操作对象实例</span>
      <span class="token punctuation">.</span>rewriteDataFiles<span class="token punctuation">(</span>table<span class="token punctuation">)</span> <span class="token comment">//将表中的数据重写成查询引擎可读的格式</span>
      <span class="token punctuation">.</span>filter<span class="token punctuation">(</span>Expressions<span class="token punctuation">.</span>equal<span class="token punctuation">(</span><span class="token string">&quot;category&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//使用Iceberg表达式引擎过滤category列等于a的记录</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;target-file-size-bytes&quot;</span><span class="token punctuation">,</span> <span class="token number">1024L</span><span class="token punctuation">.</span>toString<span class="token punctuation">)</span> <span class="token comment">//设置目标文件大小为1KB</span>
      <span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//执行合并小文件操作并生成新版本</span>
  <span class="token punctuation">}</span>


  <span class="token comment">/**
   * 加载指定快照 ID 下的 Iceberg 表元数据并返回 DataFrame
   *
   * @return DataFrame 对象
   */</span>
  <span class="token keyword">def</span> loadSnapshotDataFiles<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    spark<span class="token punctuation">.</span>read<span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">&quot;iceberg&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;snapshot-id&quot;</span><span class="token punctuation">,</span> <span class="token number">4809403494114685238L</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">&quot;iceberg_hadoop.default.sample1.files&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 加载指定 Iceberg 表的元数据并返回 DataFrame
   *
   * @param fullTableName 完整的表名，包括数据库名称和表名称
   * @return DataFrame 对象
   */</span>
  <span class="token keyword">def</span> loadIcebergTableFiles<span class="token punctuation">(</span>fullTableName<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    spark<span class="token punctuation">.</span>read<span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">&quot;iceberg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>load<span class="token punctuation">(</span>fullTableName <span class="token operator">+</span> <span class="token string">&quot;.files&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 加载指定 Iceberg 表的元数据并返回 DataFrame
   *
   * @return DataFrame 对象
   */</span>
  <span class="token keyword">def</span> loadIcebergTableFiles<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    spark<span class="token punctuation">.</span>read<span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">&quot;iceberg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">&quot;hdfs://172.16.24.198:8020/warehouse/spark-iceberg-code/default/sample1#files&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 读取指定两个快照 ID 之间增量数据并返回 DataFrame 对象
   *
   * @param hadoopNamespace Hadoop 的名称空间
   * @param tableName       表的名称
   * @return DataFrame 对象
   */</span>
  <span class="token keyword">def</span> getTwoSnapshotsIncrementalData<span class="token punctuation">(</span>hadoopNamespace<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> tableName<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> DataFrame <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 构建表在 HDFS 上的路径</span>
    <span class="token keyword">val</span> tableHDFS <span class="token operator">=</span> <span class="token string-interpolation"><span class="token id function">s</span><span class="token string">&quot;hdfs://172.16.24.198:8020/warehouse/spark-iceberg-code/</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">hadoopNamespace</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">tableName</span></span><span class="token string">&quot;</span></span>
    <span class="token comment">// 使用 Iceberg 的格式加载指定两个快照 ID 之间的增量数据，并返回 DataFrame 对象</span>
    spark<span class="token punctuation">.</span>read
      <span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">&quot;iceberg&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;start-snapshot-id&quot;</span><span class="token punctuation">,</span> <span class="token number">4809403494114685238L</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;end-snapshot-id&quot;</span><span class="token punctuation">,</span> <span class="token number">1150221491570194004L</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>load<span class="token punctuation">(</span>tableHDFS<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>


  <span class="token comment">/**
   * 查询指定快照 ID 的数据
   *
   * @param hadoopNamespace Hadoop 的名称空间
   * @param tableName       表的名称
   * @return DataFrame 对象
   */</span>
  <span class="token keyword">def</span> querySnapshotData<span class="token punctuation">(</span>hadoopNamespace<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> tableName<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 构建表在 HDFS 上的路径</span>
    <span class="token keyword">val</span> tableHDFS <span class="token operator">=</span> <span class="token string">&quot;hdfs://172.16.24.198:8020/warehouse/spark-iceberg-code/&quot;</span> <span class="token operator">+</span> hadoopNamespace <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> tableName
    <span class="token comment">// 使用 Iceberg 的格式加载指定快照 ID 的数据，并返回 DataFrame 对象</span>
    spark<span class="token punctuation">.</span>read
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;snapshot-id&quot;</span><span class="token punctuation">,</span> <span class="token number">1150221491570194004L</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">&quot;iceberg&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>load<span class="token punctuation">(</span>tableHDFS<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>


  <span class="token comment">/**
   * 查询指定时间戳之前的数据
   *
   * @param hadoopNamespace Hadoop 的 namespace
   * @param tableName       表格名称
   * @return DataFrame 对象
   */</span>
  <span class="token keyword">def</span> queryDataBeforeTimestamp<span class="token punctuation">(</span>hadoopNamespace<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> tableName<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 拼接表格在 HDFS 上的路径</span>
    <span class="token keyword">val</span> tableHDFS <span class="token operator">=</span> <span class="token string">&quot;hdfs://172.16.24.198:8020/warehouse/spark-iceberg-code/&quot;</span> <span class="token operator">+</span> hadoopNamespace <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> tableName
    <span class="token comment">// 使用 Iceberg 的方式获取指定时间戳之前的数据</span>
    spark<span class="token punctuation">.</span>read
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;as-of-timestamp&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1681804793000&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">&quot;iceberg&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>load<span class="token punctuation">(</span>tableHDFS<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>


  <span class="token comment">/**
   * 使用 Spark SQL 的方式展示指定表格的数据
   *
   * @param hadoopCatalogAndNamespace Hadoop Catalog 和 namespace，格式为 &quot;catalog.namespace&quot;
   * @param tableName                 表格名称
   */</span>
  <span class="token keyword">def</span> showTableData1<span class="token punctuation">(</span>hadoopCatalogAndNamespace<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> tableName<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 切换到指定的 namespace</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;use &quot;</span> <span class="token operator">+</span> hadoopCatalogAndNamespace<span class="token punctuation">)</span>
    <span class="token comment">// 获取指定表格的全部数据</span>
    spark<span class="token punctuation">.</span>table<span class="token punctuation">(</span>tableName<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 使用 Spark SQL 的方式展示指定表格的数据
   *
   * @param hadoopCatalogAndNamespace Hadoop Catalog 和 namespace，格式为 &quot;catalog.namespace&quot;
   * @param tableName                 表格名称
   */</span>
  <span class="token keyword">def</span> showTableData2<span class="token punctuation">(</span>hadoopCatalogAndNamespace<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> tableName<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 切换到指定的 namespace</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;use &quot;</span> <span class="token operator">+</span> hadoopCatalogAndNamespace<span class="token punctuation">)</span>
    <span class="token comment">// 获取指定表格的全部数据</span>
    spark<span class="token punctuation">.</span>table<span class="token punctuation">(</span>tableName<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 使用 Iceberg 的方式展示指定表格的数据
   *
   * @param hadoopNamespace Hadoop 的 namespace
   * @param tableName       表格名称
   */</span>
  <span class="token keyword">def</span> showTableData3<span class="token punctuation">(</span>hadoopNamespace<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> tableName<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 拼接表格在 HDFS 上的路径</span>
    <span class="token keyword">val</span> tableHDFS <span class="token operator">=</span> <span class="token string">&quot;hdfs://172.16.24.198:8020/warehouse/spark-iceberg-code/&quot;</span> <span class="token operator">+</span> hadoopNamespace <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> tableName
    <span class="token comment">// 通过 Iceberg 的方式获取指定表格的全部数据</span>
    spark<span class="token punctuation">.</span>read
      <span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">&quot;iceberg&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>load<span class="token punctuation">(</span>tableHDFS<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>


  <span class="token comment">/**
   * 打印 DataFrame 中的数据，格式为每行数据按列名分割，行与行之间使用分隔符分割
   *
   * @param dataFrame DataFrame 对象
   */</span>
  <span class="token keyword">def</span> printDataFrame<span class="token punctuation">(</span>dataFrame<span class="token operator">:</span> DataFrame<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取 DataFrame 的 schema 信息</span>
    <span class="token keyword">val</span> schema <span class="token operator">=</span> dataFrame<span class="token punctuation">.</span>schema<span class="token punctuation">.</span>fields
    <span class="token comment">// 遍历 DataFrame 中的每一行数据，使用 &quot;getAs()&quot; 方法获取每一列的值</span>
    dataFrame<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>row <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">&lt;-</span> <span class="token number">0</span> until schema<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        println<span class="token punctuation">(</span>schema<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> row<span class="token punctuation">.</span>getAs<span class="token punctuation">(</span>schema<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 使用分隔符分割不同行</span>
      println<span class="token punctuation">(</span><span class="token string">&quot;----------------------------------------------&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>


  <span class="token comment">/**
   * 查看指定库的所有表
   */</span>
  <span class="token keyword">def</span> showTables<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;use iceberg_hadoop.default&quot;</span><span class="token punctuation">)</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;show tables&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 创建表
   *
   * @param catalogAndNamespace
   * @param tableName
   */</span>
  <span class="token keyword">def</span> createTable<span class="token punctuation">(</span>catalogAndNamespace<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> tableName<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;CREATE TABLE if not exists &quot;</span> <span class="token operator">+</span> catalogAndNamespace <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> tableName <span class="token operator">+</span> <span class="token string">&quot; ( id bigint COMMENT 'unique id', data string) USING iceberg;&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 如果不存在创建数据库
   */</span>
  <span class="token keyword">def</span> createDatabase<span class="token punctuation">(</span>catalogAndNamespace<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;create database if not exists &quot;</span> <span class="token operator">+</span> catalogAndNamespace<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>


<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br><span class="line-number">288</span><br><span class="line-number">289</span><br><span class="line-number">290</span><br><span class="line-number">291</span><br><span class="line-number">292</span><br><span class="line-number">293</span><br><span class="line-number">294</span><br><span class="line-number">295</span><br><span class="line-number">296</span><br><span class="line-number">297</span><br><span class="line-number">298</span><br><span class="line-number">299</span><br><span class="line-number">300</span><br><span class="line-number">301</span><br><span class="line-number">302</span><br><span class="line-number">303</span><br><span class="line-number">304</span><br><span class="line-number">305</span><br><span class="line-number">306</span><br><span class="line-number">307</span><br><span class="line-number">308</span><br><span class="line-number">309</span><br><span class="line-number">310</span><br><span class="line-number">311</span><br><span class="line-number">312</span><br><span class="line-number">313</span><br><span class="line-number">314</span><br><span class="line-number">315</span><br><span class="line-number">316</span><br><span class="line-number">317</span><br><span class="line-number">318</span><br><span class="line-number">319</span><br><span class="line-number">320</span><br><span class="line-number">321</span><br><span class="line-number">322</span><br><span class="line-number">323</span><br><span class="line-number">324</span><br><span class="line-number">325</span><br><span class="line-number">326</span><br><span class="line-number">327</span><br><span class="line-number">328</span><br><span class="line-number">329</span><br><span class="line-number">330</span><br><span class="line-number">331</span><br><span class="line-number">332</span><br><span class="line-number">333</span><br><span class="line-number">334</span><br><span class="line-number">335</span><br><span class="line-number">336</span><br><span class="line-number">337</span><br><span class="line-number">338</span><br><span class="line-number">339</span><br><span class="line-number">340</span><br><span class="line-number">341</span><br><span class="line-number">342</span><br><span class="line-number">343</span><br><span class="line-number">344</span><br><span class="line-number">345</span><br><span class="line-number">346</span><br><span class="line-number">347</span><br><span class="line-number">348</span><br><span class="line-number">349</span><br><span class="line-number">350</span><br><span class="line-number">351</span><br><span class="line-number">352</span><br><span class="line-number">353</span><br><span class="line-number">354</span><br><span class="line-number">355</span><br><span class="line-number">356</span><br><span class="line-number">357</span><br><span class="line-number">358</span><br><span class="line-number">359</span><br><span class="line-number">360</span><br><span class="line-number">361</span><br><span class="line-number">362</span><br><span class="line-number">363</span><br><span class="line-number">364</span><br><span class="line-number">365</span><br><span class="line-number">366</span><br><span class="line-number">367</span><br><span class="line-number">368</span><br><span class="line-number">369</span><br><span class="line-number">370</span><br><span class="line-number">371</span><br><span class="line-number">372</span><br><span class="line-number">373</span><br><span class="line-number">374</span><br><span class="line-number">375</span><br><span class="line-number">376</span><br><span class="line-number">377</span><br><span class="line-number">378</span><br><span class="line-number">379</span><br><span class="line-number">380</span><br><span class="line-number">381</span><br><span class="line-number">382</span><br><span class="line-number">383</span><br><span class="line-number">384</span><br><span class="line-number">385</span><br><span class="line-number">386</span><br><span class="line-number">387</span><br><span class="line-number">388</span><br><span class="line-number">389</span><br><span class="line-number">390</span><br><span class="line-number">391</span><br><span class="line-number">392</span><br><span class="line-number">393</span><br><span class="line-number">394</span><br><span class="line-number">395</span><br><span class="line-number">396</span><br><span class="line-number">397</span><br><span class="line-number">398</span><br><span class="line-number">399</span><br><span class="line-number">400</span><br><span class="line-number">401</span><br><span class="line-number">402</span><br><span class="line-number">403</span><br><span class="line-number">404</span><br><span class="line-number">405</span><br><span class="line-number">406</span><br><span class="line-number">407</span><br><span class="line-number">408</span><br><span class="line-number">409</span><br><span class="line-number">410</span><br><span class="line-number">411</span><br><span class="line-number">412</span><br><span class="line-number">413</span><br><span class="line-number">414</span><br><span class="line-number">415</span><br><span class="line-number">416</span><br><span class="line-number">417</span><br><span class="line-number">418</span><br><span class="line-number">419</span><br><span class="line-number">420</span><br><span class="line-number">421</span><br><span class="line-number">422</span><br><span class="line-number">423</span><br><span class="line-number">424</span><br><span class="line-number">425</span><br><span class="line-number">426</span><br><span class="line-number">427</span><br><span class="line-number">428</span><br><span class="line-number">429</span><br><span class="line-number">430</span><br><span class="line-number">431</span><br><span class="line-number">432</span><br><span class="line-number">433</span><br><span class="line-number">434</span><br><span class="line-number">435</span><br><span class="line-number">436</span><br><span class="line-number">437</span><br><span class="line-number">438</span><br><span class="line-number">439</span><br><span class="line-number">440</span><br><span class="line-number">441</span><br><span class="line-number">442</span><br><span class="line-number">443</span><br><span class="line-number">444</span><br><span class="line-number">445</span><br><span class="line-number">446</span><br><span class="line-number">447</span><br><span class="line-number">448</span><br><span class="line-number">449</span><br><span class="line-number">450</span><br><span class="line-number">451</span><br><span class="line-number">452</span><br><span class="line-number">453</span><br></div></div><h3 id="配置文件"><a href="#配置文件" class="header-anchor">#</a> 配置文件</h3> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spark-iceberg<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scala.binary.version</span><span class="token punctuation">&gt;</span></span>2.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scala.binary.version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spark.version</span><span class="token punctuation">&gt;</span></span>3.2.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spark.version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.source</span><span class="token punctuation">&gt;</span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.source</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.target</span><span class="token punctuation">&gt;</span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.target</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- Spark的依赖引入 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spark-core_${scala.binary.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!--            &lt;scope&gt;provided&lt;/scope&gt;--&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spark.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spark-sql_${scala.binary.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!--            &lt;scope&gt;provided&lt;/scope&gt;--&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spark.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spark-hive_${scala.binary.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!--            &lt;scope&gt;provided&lt;/scope&gt;--&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spark.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token comment">&lt;!--fastjson &lt;= 1.2.80 存在安全漏洞,--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.83<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>


        <span class="token comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.iceberg/iceberg-spark-runtime-3.3 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.iceberg<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>iceberg-spark-runtime-3.2_2.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>


    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!-- assembly打包插件 --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>maven-assembly-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>make-assembly<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase</span><span class="token punctuation">&gt;</span></span>package<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phase</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>single<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>archive</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifest</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>manifest</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>archive</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>descriptorRefs</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>descriptorRef</span><span class="token punctuation">&gt;</span></span>jar-with-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>descriptorRef</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>descriptorRefs</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>

            <span class="token comment">&lt;!--Maven编译scala所需依赖--&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>net.alchim31.maven<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>scala-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.2.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>compile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>testCompile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br></div></div><h2 id="可能遇到的问题"><a href="#可能遇到的问题" class="header-anchor">#</a> 可能遇到的问题</h2> <h3 id="启动spark-sql异常a-read-only-user-or-a-user-in-a-read-only-database-is-not-permitted-to-disable-read-only-mode-on-a-connection"><a href="#启动spark-sql异常a-read-only-user-or-a-user-in-a-read-only-database-is-not-permitted-to-disable-read-only-mode-on-a-connection" class="header-anchor">#</a> 启动spark-sql异常<code>A read-only user or a user in a read-only database is not permitted to disable read-only mode on a connection.</code></h3> <p>完整内容：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>23/04/13 15:36:51 ERROR PoolWatchThread: Error in trying to obtain a connection. Retrying in 7000ms
java.sql.SQLException: A read-only user or a user in a read-only database is not permitted to disable read-only mode on a connection.
        at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(Unknown Source)
        at org.apache.derby.impl.jdbc.Util.generateCsSQLException(Unknown Source)
        at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(Unknown Source)
        at org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(Unknown Source)
        at org.apache.derby.impl.jdbc.EmbedConnection.handleException(Unknown Source)
        at org.apache.derby.impl.jdbc.EmbedConnection.setReadOnly(Unknown Source)
        at com.jolbox.bonecp.ConnectionHandle.setReadOnly(ConnectionHandle.java:1324)
        at com.jolbox.bonecp.ConnectionHandle.&lt;init&gt;(ConnectionHandle.java:262)
        at com.jolbox.bonecp.PoolWatchThread.fillConnections(PoolWatchThread.java:115)
        at com.jolbox.bonecp.PoolWatchThread.run(PoolWatchThread.java:82)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
        at java.lang.Thread.run(Thread.java:748)
Caused by: ERROR 25505: A read-only user or a user in a read-only database is not permitted to disable read-only mode on a connection.
        at org.apache.derby.iapi.error.StandardException.newException(Unknown Source)
        at org.apache.derby.iapi.error.StandardException.newException(Unknown Source)
        at org.apache.derby.impl.sql.conn.GenericAuthorizer.setReadOnlyConnection(Unknown Source)
        at org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.setReadOnly(Unknown Source)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>解决方法：</p> <p>删除当前执行所在目录的<code>metastore_db/db.lck</code>文件</p> <p>show current namespace;</p></div></div>  <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/04/26, 17:38:02</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/9a96a6/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">数据湖Iceberg-Hive集成Iceberg(3)</div></a> <a href="/pages/12fe6d/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">数据湖Iceberg-FlinkSQL集成(5)</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/9a96a6/" class="prev">数据湖Iceberg-Hive集成Iceberg(3)</a></span> <span class="next"><a href="/pages/12fe6d/">数据湖Iceberg-FlinkSQL集成(5)</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/072cb2/"><div>
            TODO-Clickhouse-Explain查看执行计划
            <!----></div></a> <span class="date">07-02</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/f4e4dc/"><div>
            Ambari自定义服务开发-metainfo详细介绍
            <!----></div></a> <span class="date">07-01</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/4983ce/"><div>
            IoTDB服务安装教程-单机版
            <!----></div></a> <span class="date">07-01</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:745925668@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://datamining.blog.csdn.net/" title="CSDN" target="_blank" class="iconfont icon-csdn"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2016-2025
    <span><a href="https://datamining.blog.csdn.net/">Jast-zsh</a> | <a href="https://github.com/xugaoyi/vuepress-theme-vdoing/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.a5c64990.js" defer></script><script src="/assets/js/2.9cc65402.js" defer></script><script src="/assets/js/249.4c6c1707.js" defer></script>
  </body>
</html>
