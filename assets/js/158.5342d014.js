(window.webpackJsonp=window.webpackJsonp||[]).push([[158],{526:function(e,s,t){"use strict";t.r(s);var a=t(8),r=Object(a.a)({},(function(){var e=this,s=e._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("p",[e._v("[toc]")]),e._v(" "),s("p",[e._v("根据ES的写入原理分析，默认每秒从memory buffer里面搬运数据到filesystem  cache，生产一个segments段，由后台程序定期分梯队进行合并（该部分原理还没深入研究），不过从查看到的segments数量，大小来看，默认的合并效果并不好，会出现很多小segments没有合并。根据操作系统的原理，一个索引打开太多的文件，势必会影响性能，ES也开放了相应的接口给用户对这些segments经行手动合并。")]),e._v(" "),s("p",[e._v("下面介绍一下"),s("code",[e._v("forcemerge")]),e._v("相关命令")]),e._v(" "),s("h3",{attrs:{id:"执行合并segment"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#执行合并segment"}},[e._v("#")]),e._v(" 执行合并segment")]),e._v(" "),s("p",[e._v("计算规则(参考)：按照每个segment 5GB 来评估 "),s("code",[e._v("max_num_segments")]),e._v("，根据实际情况，比如 index最大的分片5gb，"),s("code",[e._v("max_num_segments")]),e._v("就是1.")]),e._v(" "),s("p",[e._v("max_num_segments取值为：max_num_segments =（单个索引的大小G/分片数/5G）")]),e._v(" "),s("p",[s("strong",[e._v("建议每天业务低峰进行一次")])]),e._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[e._v("POST indexname/_forcemerge?max_num_segments"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),e._v("\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[e._v("参数说明:")]),e._v(" "),s("table",[s("thead",[s("tr",[s("th",[e._v("参数")]),e._v(" "),s("th",[e._v("说明")])])]),e._v(" "),s("tbody",[s("tr",[s("td",[e._v("max_num_segments")]),e._v(" "),s("td",[e._v("合并到的段数。要完全合并索引，请将其设置为1。默认值是简单地检查是否需要执行合并，如果需要，则执行合并。")])]),e._v(" "),s("tr",[s("td",[e._v("only_expunge_deletes")]),e._v(" "),s("td",[e._v("合并过程应该只删除其中有删除的段。在Lucene中，不会从段中删除文档，而只是将其标记为已删除。在段的合并过程中，将创建一个没有这些删除的新段。此标志仅允许合并具有删除的段。默认为false。请注意，这不会超过 index.merge.policy.expunge_deletes_allowed阈值。")])]),e._v(" "),s("tr",[s("td",[e._v("flush")]),e._v(" "),s("td",[e._v("强制合并后是否应该执行刷新。默认为 true。")])])])]),e._v(" "),s("h3",{attrs:{id:"查看每台机器执行merge线程数"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#查看每台机器执行merge线程数"}},[e._v("#")]),e._v(" 查看每台机器执行merge线程数")]),e._v(" "),s("p",[s("code",[e._v("GET _cat/thread_pool/force_merge?v&s=name")])]),e._v(" "),s("h3",{attrs:{id:"查看哪些index在merge"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#查看哪些index在merge"}},[e._v("#")]),e._v(" 查看哪些index在merge")]),e._v(" "),s("p",[s("code",[e._v("GET /_cat/indices/?s=segmentsCount:desc&v&h=index,segmentsCount,segmentsMemory,memoryTotal,mergesCurrent,mergesCurrentDocs,storeSize,p,r")])]),e._v(" "),s("p",[e._v("![image-20220927102918000](12.ElastiSearch Merger.assets/image-20220927102918000.png)")]),e._v(" "),s("h3",{attrs:{id:"使用task-api-查看force-merge"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用task-api-查看force-merge"}},[e._v("#")]),e._v(" 使用task api 查看force merge")]),e._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[e._v("GET _tasks?detailed"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("true"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("&")]),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("actions")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("*forcemerge\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("h3",{attrs:{id:"查看segment"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#查看segment"}},[e._v("#")]),e._v(" 查看segment")]),e._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[e._v("GET _cat/segments?v"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("&")]),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("h")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("shard,segment,size.memory\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("h3",{attrs:{id:"查看索引大小"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#查看索引大小"}},[e._v("#")]),e._v(" 查看索引大小")]),e._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[e._v("GET _cat/indices/ads_user_profile?v\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])])])}),[],!1,null,null,null);s.default=r.exports}}]);