(window.webpackJsonp=window.webpackJsonp||[]).push([[202],{566:function(s,a,t){"use strict";t.r(a);var e=t(8),r=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"hbase-基于-snapshot-迁移"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#hbase-基于-snapshot-迁移"}},[s._v("#")]),s._v(" HBase 基于 Snapshot 迁移")]),s._v(" "),a("p",[s._v("HBase 表基于 Hadoop HDFS 构建，因此迁移可以从两个维度进行：HDFS 层面的 "),a("code",[s._v("distcp")]),s._v(" 迁移，以及 HBase 层面的工具迁移。本文将重点介绍推荐的 Snapshot 迁移方案。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://s2.loli.net/2023/03/20/W1CJvibBaOf7USj.png",alt:"img"}}),s._v(" "),a("em",[s._v("图 1. HBase 多种迁移方案")])]),s._v(" "),a("p",[s._v("基于 Snapshot 的迁移具有快速、可靠的优势，尤其在跨集群操作时效率更高。以下是基于 Snapshot 的具体迁移步骤。")]),s._v(" "),a("h2",{attrs:{id:"迁移步骤"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#迁移步骤"}},[s._v("#")]),s._v(" 迁移步骤")]),s._v(" "),a("h3",{attrs:{id:"_1-在新集群上创建与原集群表结构一致的表"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-在新集群上创建与原集群表结构一致的表"}},[s._v("#")]),s._v(" 1. 在新集群上创建与原集群表结构一致的表")]),s._v(" "),a("p",[s._v("首先，在目标集群中手动创建与源集群中相同的表结构。这确保在恢复 Snapshot 时，表能正确匹配。")]),s._v(" "),a("h3",{attrs:{id:"_2-在源集群中创建快照"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-在源集群中创建快照"}},[s._v("#")]),s._v(" 2. 在源集群中创建快照")]),s._v(" "),a("p",[s._v("使用 HBase Shell，在源集群中创建当前表的快照。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ ./bin/hbase shell  \nhbase"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" snapshot "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'myTable'")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'myTableSnapshot'")]),s._v("  \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("ul",[a("li",[a("code",[s._v("'myTable'")]),s._v(" 是 HBase 表名")]),s._v(" "),a("li",[a("code",[s._v("'myTableSnapshot'")]),s._v(" 是快照名称")])]),s._v(" "),a("p",[s._v("你可以使用 "),a("code",[s._v("list_snapshots")]),s._v(" 命令查看创建的快照，也可以通过 "),a("code",[s._v("delete_snapshot")]),s._v(" 删除快照：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("hbase"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" list_snapshots  \nhbase"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" delete_snapshot "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'myTableSnapshot'")]),s._v("  \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h3",{attrs:{id:"_3-导出快照到目标集群"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-导出快照到目标集群"}},[s._v("#")]),s._v(" 3. 导出快照到目标集群")]),s._v(" "),a("p",[s._v("使用 "),a("code",[s._v("ExportSnapshot")]),s._v(" 工具，将快照从源集群导出到目标集群的 HDFS 中。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("hbase org.apache.hadoop.hbase.snapshot.ExportSnapshot "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-snapshot")]),s._v(" myTableSnapshot "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    -copy-to hdfs://10.0.0.38:4007/apps/hbase/data/temp_snapshot/myTableSnapshot\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("ul",[a("li",[a("code",[s._v("hdfs://10.0.0.38:4007")]),s._v(" 是源集群的 "),a("code",[s._v("fs.defaultFS")]),s._v(" 值（在 "),a("code",[s._v("core-site.xml")]),s._v(" 文件中可找到）")]),s._v(" "),a("li",[a("code",[s._v("-copy-to")]),s._v(" 指定目标快照存储位置，如："),a("code",[s._v("${hbase.rootdir}")]),s._v("/temp_snapshot/"),a("code",[s._v("{快照名称}")])])]),s._v(" "),a("p",[s._v("此时，系统将启动一个 MapReduce 任务，导出大数据量时，可以通过增加 "),a("code",[s._v("-mappers 16 -bandwidth 200")]),s._v(" 指定 mapper 数量和带宽（例如 200MB/sec）。")]),s._v(" "),a("h3",{attrs:{id:"_4-将快照同步到目标集群的-hdfs"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-将快照同步到目标集群的-hdfs"}},[s._v("#")]),s._v(" 4. 将快照同步到目标集群的 HDFS")]),s._v(" "),a("p",[s._v("在目标集群中执行如下命令，将快照数据从 HDFS 复制到 HBase 的 rootdir 目录中：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("hbase org.apache.hadoop.hbase.snapshot.ExportSnapshot "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-snapshot")]),s._v(" myTableSnapshot "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    -copy-from /apps/hbase/data/temp_snapshot/myTableSnapshot "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    -copy-to /hbase/\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("ul",[a("li",[a("code",[s._v("-copy-from")]),s._v(" 表示快照在源集群的存储位置")]),s._v(" "),a("li",[a("code",[s._v("-copy-to")]),s._v(" 表示目标集群中 HBase 的 rootdir 目录")])]),s._v(" "),a("p",[a("strong",[s._v("注意")]),s._v(": 完成复制后，需要检查目标集群中 HDFS 目录的权限。如果所有者是 "),a("code",[s._v("hdfs")]),s._v("，需要修改为 "),a("code",[s._v("hbase")]),s._v("，否则会在恢复时遇到权限问题：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("hdfs dfs "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-chown")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-R")]),s._v(" hbase /apps/hbase/data\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"_5-删除临时快照存储目录"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-删除临时快照存储目录"}},[s._v("#")]),s._v(" 5. 删除临时快照存储目录")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("hdfs dfs "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-rmr")]),s._v(" /apps/hbase/data/temp_snapshot/myTableSnapshot\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"_5-恢复快照至-hbase-表"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-恢复快照至-hbase-表"}},[s._v("#")]),s._v(" 5. 恢复快照至 HBase 表")]),s._v(" "),a("p",[s._v("禁用目标集群中的目标表，然后使用快照恢复数据：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("hbase"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" disable "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'myTable'")]),s._v("  \nhbase"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" restore_snapshot "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'myTableSnapshot'")]),s._v("  \nhbase"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'myTable'")]),s._v("  \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h3",{attrs:{id:"_6-测试恢复的表数据"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-测试恢复的表数据"}},[s._v("#")]),s._v(" 6. 测试恢复的表数据")]),s._v(" "),a("p",[s._v("最后，可以通过一些简单的 HBase 表操作测试恢复是否成功，确保数据和结构一致。")])])}),[],!1,null,null,null);a.default=r.exports}}]);