(window.webpackJsonp=window.webpackJsonp||[]).push([[285],{651:function(s,a,t){"use strict";t.r(a);var n=t(8),e=Object(n.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"nginx-高可用-nginx-keepalived"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#nginx-高可用-nginx-keepalived"}},[s._v("#")]),s._v(" Nginx 高可用（Nginx+Keepalived ）")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("安装keepalived")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("yum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-y")]),s._v(" keepalived\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("修改配置文件")]),s._v(" "),a("p",[s._v("配置文件"),a("code",[s._v("/etc/keepalived/keepalived.conf")])]),s._v(" "),a("p",[a("strong",[s._v("配置文件说明:")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# global_defs 模块")]),s._v("\nglobal_defs "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    notification_email "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        jast_zsh@foxmail.com\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    notification_email_from sns-lvs@gmail.com\n    smtp_server smtp.hysec.com\n    smtp_connection_timeout "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),s._v("\n    router_id nginx_master        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置 master的id，在一个网络下应该是唯一的（我们也可以设置与hostname相同这样可以保证）")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vrrp_script 模块")]),s._v("\nvrrp_script chk_http_port "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    script "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/usr/local/src/check_nginx_pid.sh"')]),s._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#最后手动执行下此脚本，以确保此脚本能够正常执行")]),s._v("\n    interval "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("                          "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#（检测脚本执行的间隔，单位是秒）")]),s._v("\n    weight "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vrrp_instance 模块")]),s._v("\nvrrp_instance  VI_1 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    state MASTER            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定keepalived的角色，MASTER为主，BACKUP为备")]),s._v("\n    interface ens192            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 当前进行vrrp通讯的网络接口卡(当前centos的网卡)")]),s._v("\n    virtual_router_id "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("66")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 虚拟路由编号，主从要一直")]),s._v("\n    priority "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 优先级，数值越大，获取处理请求的优先级越高")]),s._v("\n    advert_int "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 检查间隔，默认为1s(vrrp组播周期秒数)")]),s._v("\n    authentication "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        auth_type PASS\n        auth_pass "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1111")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    track_script "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    chk_http_port            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#（调用检测脚本）")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    virtual_ipaddress "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.8")]),s._v(".10.99\n        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.8")]),s._v(".10.98\t\t\t\t\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 定义虚拟ip(VIP)，可多设，每行一个，注意这里设置的ip要与所在网段相同，否则无法生效")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br")])]),a("blockquote",[a("p",[s._v("vrrp_instance.interface 取值：服务器使用的网卡，"),a("code",[s._v("ens192")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@localhost src"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ifconfig")]),s._v("\nens192: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("flags")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("416")]),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("3")]),s._v("<")]),s._v("UP,BROADCAST,RUNNING,MULTICAST"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("  mtu "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1500")]),s._v("\n     inet "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.8")]),s._v(".10.23  netmask "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("255.255")]),s._v(".255.0  broadcast "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.8")]),s._v(".10.255\n     inet6 fe80::a3c0:ef25:a705:2ae1  prefixlen "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("  scopeid 0x2"),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("0")]),s._v("<")]),s._v("link"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n     ether 00:0c:29:45:83:22  txqueuelen "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Ethernet"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n     RX packets "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("135400")]),s._v("  bytes "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("93376258")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("89.0")]),s._v(" MiB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n     RX errors "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  dropped "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("158")]),s._v("  overruns "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  frame "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n     TX packets "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("109485")]),s._v("  bytes "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("186236718")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("177.6")]),s._v(" MiB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n     TX errors "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  dropped "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" overruns "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  carrier "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  collisions "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n\nlo: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("flags")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("3")]),s._v("<")]),s._v("UP,LOOPBACK,RUNNING"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("  mtu "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("65536")]),s._v("\n     inet "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1  netmask "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("255.0")]),s._v(".0.0\n     inet6 ::1  prefixlen "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("128")]),s._v("  scopeid 0x1"),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("0")]),s._v("<")]),s._v("host"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n     loop  txqueuelen "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Local Loopback"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n     RX packets "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("59809")]),s._v("  bytes "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("92054271")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("87.7")]),s._v(" MiB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n     RX errors "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  dropped "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  overruns "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  frame "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n     TX packets "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("59809")]),s._v("  bytes "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("92054271")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("87.7")]),s._v(" MiB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n     TX errors "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  dropped "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" overruns "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  carrier "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  collisions "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])])]),s._v(" "),a("ol",[a("li",[s._v("MASTER 配置")])]),s._v(" "),a("div",{staticClass:"language-properties line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-properties"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("global_defs")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("{")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    notification_email")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("{")]),s._v("\n        jast_zsh@foxmail.com\n    }\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    notification_email_from")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("sns-lvs@gmail.com")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    smtp_server")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("smtp.hysec.com")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    smtp_connection_timeout")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("30")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    router_id")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("nginx_master        # 设置 master的id，在一个网络应该是唯一的")]),s._v("\n}\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("vrrp_script")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("chk_http_port {")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    script")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v('"/usr/local/src/check_nginx_pid.sh"    #最后手动执行下此脚本，以确保此脚本能够正常执行')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    interval")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("2                          #（检测脚本执行的间隔，单位是秒）")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    weight")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("2")]),s._v("\n}\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("vrrp_instance")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("VI_1 {")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    state")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("MASTER            # 指定keepalived的角色，MASTER为主，BACKUP为备")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    interface")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("ens192            # 当前进行vrrp通讯的网络接口卡(当前centos的网卡)")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    virtual_router_id")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("66        # 虚拟路由编号，主从要一直")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    priority")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("100            # 优先级，数值越大，获取处理请求的优先级越高")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    advert_int")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("1            # 检查间隔，默认为1s(vrrp组播周期秒数)")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    authentication")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("{")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("        auth_type")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("PASS")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("        auth_pass")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("1111")]),s._v("\n    }\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    track_script")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("{")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    chk_http_port")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("           #（调用检测脚本）")]),s._v("\n    }\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    virtual_ipaddress")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("{")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("        10.8.10.99")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("           # 定义虚拟ip(VIP)，可多设，每行一个")]),s._v("\n    }\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br")])]),a("ol",{attrs:{start:"2"}},[a("li",[a("p",[s._v("BACKUP配置")]),s._v(" "),a("div",{staticClass:"language-properties line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-properties"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("global_defs")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("{")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    notification_email")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("{")]),s._v("\n        jast_zsh@foxmail.com\n    }\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    notification_email_from")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("sns-lvs@gmail.com")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    smtp_server")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("smtp.hysec.com")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    smtp_connection_timeout")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("30")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    router_id")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("nginx_backup              # 设置nginx backup的id，在一个网络应该是唯一的")]),s._v("\n}\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("vrrp_script")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("chk_http_port {")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    script")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v('"/usr/local/src/check_nginx_pid.sh"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    interval")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("2                          #（检测脚本执行的间隔）")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    weight")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("2")]),s._v("\n}\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("vrrp_instance")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("VI_1 {")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    state")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("BACKUP                        # 指定keepalived的角色，MASTER为主，BACKUP为备")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    interface")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("ens192                    # 当前进行vrrp通讯的网络接口卡(当前centos的网卡)")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    virtual_router_id")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("66                # 虚拟路由编号，主从要一直")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    priority")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("99                         # 优先级，数值越大，获取处理请求的优先级越高")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    advert_int")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("1                        # 检查间隔，默认为1s(vrrp组播周期秒数)")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    authentication")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("{")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("        auth_type")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("PASS")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("        auth_pass")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("1111")]),s._v("\n    }\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    track_script")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("{")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("        chk_http_port")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("                  #（调用检测脚本）")]),s._v("\n    }\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    virtual_ipaddress")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("{")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("        10.8.10.99")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("                  # 定义虚拟ip(VIP)，可多设，每行一个")]),s._v("\n    }\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br")])])]),s._v(" "),a("li",[a("p",[a("code",[s._v("check_nginx_pid.sh")]),s._v(" 配置")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/bin/bash")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("A")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-C")]),s._v(" nginx --no-header "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wc")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-l")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("        \n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$A")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-eq")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("                            \n    /usr/local/nginx/sbin/nginx                "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#重启nginx")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-C")]),s._v(" nginx --no-header "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wc")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-l")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-eq")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#nginx重启失败")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exit")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exit")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exit")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("启动keepalived")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("systemctl start keepalived\nsystemctl status keepalived\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("设置开机自动启动")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("systemctl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" keepalived\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])])])]),s._v(" "),a("li",[a("p",[s._v("访问系统")]),s._v(" "),a("p",[s._v("此时Nginx随便挂掉一个访问虚拟IP都可以访问到相应服务")]),s._v(" "),a("p",[s._v("访问虚拟地址即可实现nginx高可用")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("http://10.8.10.99/\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])])])])}),[],!1,null,null,null);a.default=e.exports}}]);