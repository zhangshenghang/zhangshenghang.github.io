(window.webpackJsonp=window.webpackJsonp||[]).push([[165],{531:function(s,a,e){"use strict";e.r(a);var t=e(8),n=Object(t.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[s._v("[toc]")]),s._v(" "),a("h1",{attrs:{id:"深入理解-elasticsearch-慢查询日志"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#深入理解-elasticsearch-慢查询日志"}},[s._v("#")]),s._v(" 深入理解 Elasticsearch 慢查询日志")]),s._v(" "),a("p",[s._v("在现代搜索引擎和数据分析领域，Elasticsearch 无疑是其中的佼佼者。它以其强大的搜索能力、灵活的配置和高可用性而闻名。然而，随着数据量的增长和查询复杂性的提高，性能问题也时常困扰着开发者。为了解决这个问题，Elasticsearch 提供了慢查询日志功能，帮助开发者发现并优化性能瓶颈。")]),s._v(" "),a("h2",{attrs:{id:"什么是慢查询日志"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#什么是慢查询日志"}},[s._v("#")]),s._v(" 什么是慢查询日志")]),s._v(" "),a("p",[s._v("慢查询日志是 Elasticsearch 中的一项监控功能，它允许我们记录那些执行时间超过指定阈值的查询。通过分析这些日志，我们可以识别出那些性能不佳的查询，并采取相应的优化措施。")]),s._v(" "),a("h2",{attrs:{id:"如何启用慢查询日志"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#如何启用慢查询日志"}},[s._v("#")]),s._v(" 如何启用慢查询日志")]),s._v(" "),a("p",[s._v("启用慢查询日志主要分为两步：配置阈值和重启服务。")]),s._v(" "),a("ol",[a("li",[a("strong",[s._v("配置阈值：")]),s._v("\n在 Elasticsearch 的配置文件 "),a("code",[s._v("elasticsearch.yml")]),s._v(" 中，我们可以设置查询和获取阶段的慢查询阈值。例如："),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置查询阶段的慢查询阈值")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("index.search.slowlog.threshold.query.warn")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 10s\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("index.search.slowlog.threshold.query.info")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 5s\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("index.search.slowlog.threshold.query.debug")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 2s\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("index.search.slowlog.threshold.query.trace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 500ms\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置获取阶段的慢查询阈值")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("index.search.slowlog.threshold.fetch.warn")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 10s\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("index.search.slowlog.threshold.fetch.info")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 5s\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("index.search.slowlog.threshold.fetch.debug")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 2s\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("index.search.slowlog.threshold.fetch.trace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 500ms\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),s._v("这些设置将记录执行时间超过指定阈值的查询。"),a("code",[s._v("warn")]),s._v(", "),a("code",[s._v("info")]),s._v(", "),a("code",[s._v("debug")]),s._v(", "),a("code",[s._v("trace")]),s._v(" 是日志级别，可以根据需要调整。")]),s._v(" "),a("li",[a("strong",[s._v("重启 Elasticsearch 服务：")]),s._v("\n修改配置文件后，需要重启 Elasticsearch 服务以使配置生效。")])]),s._v(" "),a("h2",{attrs:{id:"慢查询日志位置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#慢查询日志位置"}},[s._v("#")]),s._v(" 慢查询日志位置")]),s._v(" "),a("p",[s._v("慢查询日志位于设置的 "),a("code",[s._v("path.logs")]),s._v(" 目录，文件名默认为 "),a("code",[s._v("index_search_slowlog_rolling")]),s._v("。如需修改，可调整 Elasticsearch 配置目录下的 "),a("code",[s._v("log4j2.properties")]),s._v(" 文件。")]),s._v(" "),a("p",[a("code",[s._v("log4j2.properties")]),s._v("配置样例")]),s._v(" "),a("div",{staticClass:"language-properties line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-properties"}},[a("code",[s._v("...\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("######## Search slowlog JSON ####################")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("appender.index_search_slowlog_rolling.type")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("RollingFile")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("appender.index_search_slowlog_rolling.name")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("index_search_slowlog_rolling")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("appender.index_search_slowlog_rolling.fileName")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("${sys:es.logs.base_path}${sys:file.separator}${sys:es.logs\\\n  .cluster_name}_index_search_slowlog.json")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("appender.index_search_slowlog_rolling.layout.type")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("ESJsonLayout")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("appender.index_search_slowlog_rolling.layout.type_name")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("index_search_slowlog")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("appender.index_search_slowlog_rolling.layout.esmessagefields")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("message,took,took_millis,total_hits,types,stats,search_type,total_shards,source,id")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("appender.index_search_slowlog_rolling.filePattern")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("${sys:es.logs.base_path}${sys:file.separator}${sys:es.logs\\\n  .cluster_name}_index_search_slowlog-%i.json.gz")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("appender.index_search_slowlog_rolling.policies.type")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("Policies")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("appender.index_search_slowlog_rolling.policies.size.type")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("SizeBasedTriggeringPolicy")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("appender.index_search_slowlog_rolling.policies.size.size")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("1GB")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("appender.index_search_slowlog_rolling.strategy.type")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("DefaultRolloverStrategy")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("appender.index_search_slowlog_rolling.strategy.max")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("4")]),s._v("\n...\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])]),a("h2",{attrs:{id:"慢查询日志分析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#慢查询日志分析"}},[s._v("#")]),s._v(" 慢查询日志分析")]),s._v(" "),a("p",[s._v("慢查询日志通常包含了查询的详细信息，如执行时间、索引名称、节点信息、查询 DSL 等。分析慢查询日志可以帮助我们找到性能瓶颈，并采取相应的优化措施。")]),s._v(" "),a("ol",[a("li",[a("strong",[s._v("日志格式：")]),s._v("\n慢查询日志的格式通常如下："),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("[日期和时间戳] [日志级别] [节点名称] [索引名称][分片ID] took[执行时间], took_millis[执行时间（毫秒）], total_hits[总命中数], types[文档类型], stats[查询统计信息], search_type[查询类型], total_shards[总分片数], source[查询 DSL]\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),s._v("通过这些信息，我们可以了解到查询的详细情况，包括执行时间、索引名称、节点信息、查询 DSL 等。")]),s._v(" "),a("li",[a("strong",[s._v("分析工具：")]),s._v("\n可以使用日志分析工具或编写脚本来自动化日志的分析过程。例如，可以使用 "),a("code",[s._v("grep")]),s._v("、"),a("code",[s._v("awk")]),s._v(" 等命令行工具，或者编写 Python 脚本来提取和分析日志数据。")]),s._v(" "),a("li",[a("strong",[s._v("Kibana：")]),s._v("\n如果你的环境中安装了 Kibana，可以使用它来可视化慢查询日志。可以通过 Filebeat 导入日志数据到 Elasticsearch，然后在 Kibana 中创建 Dashboard 来展示和分析慢查询。")])]),s._v(" "),a("h2",{attrs:{id:"慢查询日志样例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#慢查询日志样例"}},[s._v("#")]),s._v(" 慢查询日志样例")]),s._v(" "),a("p",[s._v("以下是一个慢查询日志的样例：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('[2023-04-11T12:36:01,123][WARN ][o.e.t.SearchService] [node-1] [my_index][0] took[6.2s], took_millis[6200], total_hits[1000], types[my_type], stats[...], search_type[QUERY_THEN_FETCH], total_shards[5], source[{"query":{"match_all":{}}}]\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("在这个样例中，我们可以看到：")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("日期和时间戳："),a("code",[s._v("[2023-04-11T12:36:01,123]")])])]),s._v(" "),a("li",[a("p",[s._v("日志级别："),a("code",[s._v("[WARN]")])])]),s._v(" "),a("li",[a("p",[s._v("节点名称："),a("code",[s._v("[node-1]")])])]),s._v(" "),a("li",[a("p",[s._v("索引名称："),a("code",[s._v("[my_index]")])])]),s._v(" "),a("li",[a("p",[s._v("分片ID："),a("code",[s._v("[0]")])])]),s._v(" "),a("li",[a("p",[s._v("查询类型："),a("code",[s._v("[QUERY_THEN_FETCH]")])])]),s._v(" "),a("li",[a("p",[s._v("执行时间："),a("code",[s._v("took[6.2s]")]),s._v("，表示查询执行了6.2秒")])]),s._v(" "),a("li",[a("p",[s._v("总命中数："),a("code",[s._v("total_hits[1000]")])])]),s._v(" "),a("li",[a("p",[s._v("查询 DSL："),a("code",[s._v('source[{"query":{"match_all":{}}}]')]),s._v("，表示这是一个 "),a("code",[s._v("match_all")]),s._v(" 查询")])])]),s._v(" "),a("p",[s._v("通过分析这些信息，我们可以确定哪些查询需要优化，并采取措施来提高 Elasticsearch 集群的性能。")])])}),[],!1,null,null,null);a.default=n.exports}}]);